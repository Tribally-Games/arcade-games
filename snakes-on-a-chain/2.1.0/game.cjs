"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});var Ve=Object.create,Fe=Object.getPrototypeOf,de=Object.defineProperty,je=Object.getOwnPropertyNames,Ke=Object.prototype.hasOwnProperty,Ze=(n,e,t)=>{t=n!=null?Ve(Fe(n)):{};const s=de(t,"default",{value:n,enumerable:!0});for(let i of je(n))Ke.call(s,i)||de(s,i,{get:()=>n[i],enumerable:!0});return s},Ye=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),$e=Ye((n,e)=>{(function(t,s){typeof n=="object"?e.exports=s():typeof define=="function"&&define.amd?define(s):t.Alea=s()})(n,function(){return t.importState=function(i){var r=new t;return r.importState(i),r},t;function t(){return(function(i){var r=0,o=0,a=0,h=1;i.length==0&&(i=[+new Date]);var c=s();r=c(" "),o=c(" "),a=c(" ");for(var u=0;u<i.length;u++)r-=c(i[u]),r<0&&(r+=1),o-=c(i[u]),o<0&&(o+=1),a-=c(i[u]),a<0&&(a+=1);c=null;var p=function(){var m=2091639*r+h*23283064365386963e-26;return r=o,o=a,a=m-(h=m|0)};return p.next=p,p.uint32=function(){return p()*4294967296},p.fract53=function(){return p()+(p()*2097152|0)*11102230246251565e-32},p.version="Alea 0.9",p.args=i,p.exportState=function(){return[r,o,a,h]},p.importState=function(m){r=+m[0]||0,o=+m[1]||0,a=+m[2]||0,h=+m[3]||0},p})(Array.prototype.slice.call(arguments))}function s(){var i=4022871197,r=function(o){o=o.toString();for(var a=0;a<o.length;a++){i+=o.charCodeAt(a);var h=.02519603282416938*i;i=h>>>0,h-=i,h*=i,i=h>>>0,h-=i,i+=h*4294967296}return(i>>>0)*23283064365386963e-26};return r.version="Mash 0.9",r}})}),ue;(function(n){n.SPRITESHEET="spritesheet",n.STATIC_IMAGE="staticImage",n.SOUND="sound"})(ue||(ue={}));var G;(function(n){n.READY="READY",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.ENDED="ENDED"})(G||(G={}));var pe;(function(n){n.USER_INPUT="USER_INPUT",n.OBJECT_UPDATE="OBJECT_UPDATE"})(pe||(pe={}));var ge;(function(n){n.ITEM_ADDED="itemAdded",n.ITEM_REMOVED="itemRemoved",n.LIST_CLEARED="listCleared",n.DESTROYED_ITEMS_CLEARED="destroyedItemsCleared"})(ge||(ge={}));Ze($e());var fe;(function(n){n.POINTS_CHANGED="pointsChanged"})(fe||(fe={}));var me;(function(n){n.STATE_CHANGE="stateChange"})(me||(me={}));var ye;(function(n){n.POSITION_CHANGED="positionChanged",n.HEALTH_CHANGED="healthChanged",n.MAX_HEALTH_CHANGED="maxHealthChanged",n.DESTROYED="destroyed",n.SIZE_CHANGED="sizeChanged",n.VELOCITY_CHANGED="velocityChanged",n.ROTATION_CHANGED="rotationChanged"})(ye||(ye={}));class Xe{constructor(e){this.currentIndex=0,this.events=e.map(t=>({...t})),this.currentIndex=0}getNextEvents(e){const t=[];for(;this.currentIndex<this.events.length;){const s=this.events[this.currentIndex];if(s.tick<=e)t.push(s),this.currentIndex++;else break}return t}hasMoreEvents(){return this.currentIndex<this.events.length}reset(){this.currentIndex=0}}class qe{constructor(e){this.isReplaying=!1,this.deltaTicksIndex=0,this.recording=null,this.currentReplayTick=0,this.accumulatedTicks=0,this.__engine=e,this.engine=this.createProxyEngine()}createProxyEngine(){const e=this;return new Proxy(this.__engine,{get(t,s,i){return s==="update"&&e.isReplaying&&e.recording?function(r){if(t.getState()===G.PLAYING){for(e.accumulatedTicks+=r;e.isReplaying&&t.getState()===G.PLAYING&&e.deltaTicksIndex<e.recording.deltaTicks.length&&e.accumulatedTicks>=e.recording.deltaTicks[e.deltaTicksIndex];){const a=e.recording.deltaTicks[e.deltaTicksIndex];e.deltaTicksIndex++,e.accumulatedTicks-=a,t.update(a),e.currentReplayTick+=a}if(t.getState()===G.ENDED&&e.isReplaying){e._endReplay();return}e.isReplaying&&e.deltaTicksIndex>=e.recording.deltaTicks.length&&e._endReplay()}}:Reflect.get(t,s,i)}})}getReplayEngine(){return this.engine}async replay(e){if(this.isReplaying)throw new Error("Already replaying. Stop current replay first.");this.validateRecording(e),this.isReplaying=!0,this.recording=e,this.deltaTicksIndex=0,this.currentReplayTick=0,this.accumulatedTicks=0,await this.__engine.reset(e.gameConfig);const t=new Xe(e.events);this.__engine.getEventManager().setSource(t),this.__engine.start()}_endReplay(){this.isReplaying&&(this.isReplaying=!1,this.__engine.getState()===G.PLAYING&&this.__engine.end(),this.deltaTicksIndex=0,this.accumulatedTicks=0)}stopReplay(){this._endReplay()}isCurrentlyReplaying(){return this.isReplaying}getCurrentTick(){return this.currentReplayTick}getReplayProgress(){if(!this.recording)return{isReplaying:!1,progress:0,hasMoreTicks:!1};const e=this.recording.totalTicks,t=e>0?this.currentReplayTick/e:0,s=this.isReplaying?this.deltaTicksIndex<this.recording.deltaTicks.length:t<1;return{isReplaying:this.isReplaying,progress:Math.min(1,t),hasMoreTicks:s}}validateRecording(e){if(!e)throw new Error("Invalid recording: recording is null or undefined");if(!e.gameConfig||typeof e.gameConfig!="object")throw new Error("Invalid recording: missing or invalid gameConfig");if(!Array.isArray(e.events))throw new Error("Invalid recording: events must be an array");if(!Array.isArray(e.deltaTicks))throw new Error("Invalid recording: deltaTicks must be an array");if(typeof e.totalTicks!="number"||e.totalTicks<0)throw new Error("Invalid recording: totalTicks must be a non-negative number");for(let t=0;t<e.deltaTicks.length;t++){const s=e.deltaTicks[t];if(typeof s!="number"||s<=0)throw new Error(`Invalid recording: deltaTicks[${t}] must be a positive number, got ${s}`)}for(let t=0;t<e.events.length;t++){const s=e.events[t];if(!s||typeof s!="object")throw new Error(`Invalid recording: events[${t}] must be an object`);if(!s.type||typeof s.type!="string")throw new Error(`Invalid recording: events[${t}].type must be a string`);if(typeof s.tick!="number"||s.tick<0)throw new Error(`Invalid recording: events[${t}].tick must be a non-negative number`)}}}var Ee;(function(n){n.POINTER_MOVE="pointerMove",n.POINTER_CLICK="pointerClick",n.VIEWPORT_MOVED="viewportMoved",n.VIEWPORT_ZOOMED="viewportZoomed"})(Ee||(Ee={}));var we;(function(n){n.NORMAL="normal",n.ADD="add",n.MULTIPLY="multiply",n.SCREEN="screen"})(we||(we={}));var Se;(function(n){n.LINEAR="linear",n.NEAREST="nearest"})(Se||(Se={}));var Ie;(function(n){n.SUSPENDED="suspended",n.RUNNING="running",n.CLOSED="closed"})(Ie||(Ie={}));var ie;(n=>{n.INTENT="intent"})(ie||={});var A;(n=>{n.UP="up",n.DOWN="down",n.LEFT="left",n.RIGHT="right",n.CLOCKWISE="clockwise",n.COUNTER_CLOCKWISE="counter_clockwise",n.START_MOVING_LEFT="start_moving_left",n.STOP_MOVING_LEFT="stop_moving_left",n.START_MOVING_RIGHT="start_moving_right",n.STOP_MOVING_RIGHT="stop_moving_right",n.EASTER_EGG_1="easter_egg_1",n.ACTION="action",n.PAUSE="pause",n.RESUME="resume",n.START="start",n.RESET="reset"})(A||={});function Qe(n,e,t){return{GameEngine:n,GameCanvas:e,ReplayManager:qe,GameInputType:ie,GameIntent:A,getVersion:()=>t.version,getGameModuleConfig:()=>t}}var X;(n=>{n.COLOR="COLOR",n.STRING="STRING",n.STRING_LIST="STRING_LIST",n.SPRITESHEET="SPRITESHEET"})(X||={});var Je=Object.defineProperty,et=(n,e,t)=>e in n?Je(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,v=(n,e,t)=>(et(n,typeof e!="symbol"?e+"":e,t),t);class tt{constructor(e){v(this,"_onPressed"),v(this,"_onPressedWithRepeat"),v(this,"_onReleased"),v(this,"_isPressed"),v(this,"_identity"),this._isPressed=!1,this._identity=e,typeof e=="function"?this._onPressedWithRepeat=e:(this._onPressed=e.onPressed,this._onPressedWithRepeat=e.onPressedWithRepeat,this._onReleased=e.onReleased)}get isEmpty(){return!this._onPressed&&!this._onPressedWithRepeat&&!this._onReleased}isOwnHandler(e){return this._identity===e}executePressed(e){var t,s;this._isPressed||(t=this._onPressed)==null||t.call(this,e),this._isPressed=!0,(s=this._onPressedWithRepeat)==null||s.call(this,e)}executeReleased(e){var t;this._isPressed&&((t=this._onReleased)==null||t.call(this,e)),this._isPressed=!1}}var te=class x{constructor(e,t,s={}){v(this,"_normalizedKeyCombo"),v(this,"_parsedKeyCombo"),v(this,"_handlerState"),v(this,"_keyComboEventMapper"),v(this,"_movingToNextSequenceAt"),v(this,"_sequenceIndex"),v(this,"_unitIndex"),v(this,"_lastActiveKeyPresses"),v(this,"_lastActiveKeyCount"),v(this,"_isPressedWithFinalUnit"),this._normalizedKeyCombo=x.normalizeKeyCombo(e),this._parsedKeyCombo=x.parseKeyCombo(e),this._handlerState=new tt(s),this._keyComboEventMapper=t,this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses=[],this._lastActiveKeyCount=0,this._isPressedWithFinalUnit=null}static parseKeyCombo(e){if(x._parseCache[e])return x._parseCache[e];const t=e.toLowerCase();let s="",i=[],r=[i],o=[r];const a=[o];let h=!1;for(let u=0;u<e.length;u+=1)if(t[u]==="\\")h=!0;else if((t[u]==="+"||t[u]===">"||t[u]===",")&&!h){if(s)throw new Error("cannot have two operators in a row");s=t[u]}else t[u].match(/[^\s]/)&&(s&&(s===","?(i=[],r=[i],o=[r],a.push(o)):s===">"?(i=[],r=[i],o.push(r)):s==="+"&&(i=[],r.push(i)),s=""),h=!1,i.push(t[u]));const c=a.map(u=>u.map(p=>p.map(m=>m.join(""))));return x._parseCache[e]=c,c}static stringifyKeyCombo(e){return e.map(t=>t.map(s=>s.map(i=>i==="+"?"\\+":i===">"?"\\>":i===","?"\\,":i).join("+")).join(">")).join(",")}static normalizeKeyCombo(e){if(x._normalizationCache[e])return x._normalizationCache[e];const t=this.stringifyKeyCombo(this.parseKeyCombo(e));return x._normalizationCache[e]=t,t}get isPressed(){return!!this._isPressedWithFinalUnit}get sequenceIndex(){return this.isPressed?this._parsedKeyCombo.length:this._sequenceIndex}isOwnHandler(e){return this._handlerState.isOwnHandler(e)}executePressed(e){var t,s;!((t=this._isPressedWithFinalUnit)!=null&&t.has(e.key))&&!((s=e.aliases)!=null&&s.some(i=>{var r;return(r=this._isPressedWithFinalUnit)==null?void 0:r.has(i)}))||this._handlerState.executePressed(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,aliases:new Set(e.aliases),event:e}))}executeReleased(e){var t,s;!((t=this._isPressedWithFinalUnit)!=null&&t.has(e.key))&&!((s=e.aliases)!=null&&s.some(i=>{var r;return(r=this._isPressedWithFinalUnit)==null?void 0:r.has(i)}))||(this._handlerState.executeReleased(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,aliases:new Set(e.aliases),event:e})),this._isPressedWithFinalUnit=null)}updateState(e,t){const s=e.length,i=s<this._lastActiveKeyCount;this._lastActiveKeyCount=s;const r=this._parsedKeyCombo[this._sequenceIndex],o=r.slice(0,this._unitIndex),a=r.slice(this._unitIndex),h=()=>{this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses.length=0,this._handlerState.isEmpty&&(this._isPressedWithFinalUnit=null)};let c=0;if(i){if(this._movingToNextSequenceAt===0)return h();if(this._movingToNextSequenceAt+t<Date.now()||s!==0)return;this._movingToNextSequenceAt=0,this._sequenceIndex+=1,this._unitIndex=0;return}for(const u of o){for(const p of u){let m=!1;for(let g=c;g<e.length&&g<c+u.length;g+=1)if(e[g].key===p||e[g].aliases.has(p)){m=!0;break}if(!m)return h()}c+=u.length}if(this._movingToNextSequenceAt===0){for(const u of a){for(const p of u){let m=!1;for(let g=c;g<e.length&&g<c+u.length;g+=1)if(e[g].key===p||e[g].aliases.has(p)){m=!0;break}if(!m)return}this._unitIndex+=1,c+=u.length}if(c<s-1)return h();if(this._lastActiveKeyPresses[this._sequenceIndex]=e.slice(0),this._sequenceIndex<this._parsedKeyCombo.length-1){this._movingToNextSequenceAt=Date.now();return}this._isPressedWithFinalUnit=new Set(r[r.length-1])}}_wrapEvent(e,t){return{...this._keyComboEventMapper(e,t),keyCombo:this._normalizedKeyCombo,keyEvents:e.flat().map(s=>s.event),finalKeyEvent:t.event}}};v(te,"_parseCache",{}),v(te,"_normalizationCache",{});var ne=te;ne.normalizeKeyCombo;ne.stringifyKeyCombo;ne.parseKeyCombo;const se=["base_map","immutable_map","moku_map","avalanche_map","pixel_cats_map","abstract_map","ronin_map"];class re{constructor(e,t){this.spritesheetId=e,this.rendering=t}static async load(e,t,s,i){const r=await e.fetchData(s),o=i||`${s.replace(/\.[^.]+$/,"")}.json`,a=await e.fetchData(o);let h;typeof a=="string"?h=a===""?{frames:{}}:JSON.parse(a):h=a;const c=await t.loadSpritesheet(r,h);return new re(c,t)}getTexture(e){const t=this.rendering.getTexture(this.spritesheetId,e);return t!==null?t:void 0}getAnimationFrames(e){const t=[];let s=0;for(;s<1e3;){const i=`${e}${s}`,r=this.rendering.getTexture(this.spritesheetId,i);if(r===null)break;t.push(r),s++}return t}}var j;(function(n){n.SPRITESHEET="spritesheet",n.STATIC_IMAGE="staticImage",n.SOUND="sound"})(j||(j={}));class st{constructor(e,t,s){this.loader=e,this.rendering=t,this.audio=s,this.spritesheets=new Map,this.staticImages=new Map,this.sounds=new Set,this.registeredSpritesheets=[],this.registeredStaticImages=[],this.registeredSounds=[]}register(e,t){switch(t){case j.SPRITESHEET:this.registeredSpritesheets.includes(e)||this.registeredSpritesheets.push(e);break;case j.STATIC_IMAGE:this.registeredStaticImages.includes(e)||this.registeredStaticImages.push(e);break;case j.SOUND:this.registeredSounds.includes(e)||this.registeredSounds.push(e);break}}async preloadAssets(e){const t=[];let s=0;const i=this.registeredSpritesheets.length+this.registeredStaticImages.length+this.registeredSounds.length,r=()=>{s++,e?.(s,i)};for(const o of this.registeredSpritesheets)t.push(this.loadSpritesheet(o).then(()=>{r()}));for(const o of this.registeredStaticImages)t.push(this.loadStaticImage(o).then(()=>{r()}));for(const o of this.registeredSounds)t.push(this.loadSound(o).then(()=>{r()}));await Promise.all(t)}async loadSpritesheet(e){const t=await re.load(this.loader,this.rendering,e);return this.spritesheets.set(e,t),t}async loadStaticImage(e){const t=await this.loader.fetchData(e),s=await this.rendering.loadTexture(t);return this.staticImages.set(e,s),s}async loadSound(e){const t=await this.loader.fetchData(e);await this.audio.loadSound(e,t),this.sounds.add(e)}getSpritesheet(e){return this.spritesheets.get(e)}getStaticImage(e){return this.staticImages.get(e)}}class Y{constructor(){this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e]?.add(t)}off(e,t){this.listeners[e]?.delete(t)}emit(e,...t){this.listeners[e]?.forEach(s=>s(...t))}clearListeners(){for(const e in this.listeners)this.listeners[e]&&this.listeners[e]?.clear()}}var S;(function(n){n.READY="READY",n.PLAYING="PLAYING",n.PAUSED="PAUSED",n.ENDED="ENDED"})(S||(S={}));var K;(function(n){n.USER_INPUT="USER_INPUT",n.OBJECT_UPDATE="OBJECT_UPDATE"})(K||(K={}));class it{constructor(e,t){this.currentTick=0,this.source=e,this.engine=t}setRecorder(e){this.recorder=e}update(e,t){this.currentTick=t;const s=this.source.getNextEvents(t);for(const i of s)this.processEvent(i),this.recorder&&this.recorder.recordEvent(i)}setSource(e){this.source=e}getSource(){return this.source}reset(){this.source.reset()}processEvent(e){try{switch(e.type){case K.USER_INPUT:this.processUserInput(e);break;case K.OBJECT_UPDATE:this.processObjectUpdate(e);break;default:console.warn(`Unknown event type: ${e.type}`)}}catch(t){console.error("Error processing event:",e,t)}}processUserInput(e){this.onUserInput&&this.onUserInput(e)}processObjectUpdate(e){const t=this.engine.getGameObjectGroup(e.objectType);if(!t){console.warn(`No group found for object type: ${e.objectType}`);return}const s=t.getById(e.objectId);if(!s){console.warn(`Object not found: ${e.objectId} of type ${e.objectType}`);return}if(typeof s.getPosition=="function"){const r=s.getPosition();r&&typeof r.x=="number"&&typeof r.y=="number"&&(r.x,r.y)}const i=s[e.method];if(typeof i!="function"){console.warn(`Method not found: ${e.method} on object ${e.objectId}`);return}i.apply(s,e.params)}hasMoreEvents(){return this.source.hasMoreEvents()}getSourceInfo(){return{type:this.source.constructor.name,hasMore:this.source.hasMoreEvents()}}}var B;(function(n){n.ITEM_ADDED="itemAdded",n.ITEM_REMOVED="itemRemoved",n.LIST_CLEARED="listCleared",n.DESTROYED_ITEMS_CLEARED="destroyedItemsCleared"})(B||(B={}));class F extends Y{constructor(){super(),this.gameObjects=new Map}add(e){const t=e.getId(),s=!this.gameObjects.has(t);return this.gameObjects.set(t,e),s&&this.emit(B.ITEM_ADDED,e),e}remove(e){const t=e.getId(),s=this.gameObjects.delete(t);return s&&this.emit(B.ITEM_REMOVED,t),s}has(e){return this.gameObjects.has(e.getId())}hasId(e){return this.gameObjects.has(e)}getById(e){return this.gameObjects.get(e)}getAllActive(){return Array.from(this.gameObjects.values()).filter(e=>!e.isDestroyed())}size(){return this.gameObjects.size}activeSize(){return this.getAllActive().length}clear(){this.gameObjects.clear(),this.emit(B.LIST_CLEARED)}clearAndDestroy(){for(const e of this.gameObjects.values())e.isDestroyed()||e.destroy();this.clear()}clearDestroyed(){const e=[];for(const[t,s]of this.gameObjects)s.isDestroyed()&&(e.push(s),this.gameObjects.delete(t));return e.length>0&&this.emit(B.DESTROYED_ITEMS_CLEARED,e),e.length}update(e,t){for(const s of this.gameObjects.values())s.isDestroyed()||s.update(e,t)}}function nt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var q={exports:{}},rt=q.exports,Te;function ot(){return Te||(Te=1,(function(n,e){(function(t,s){n.exports=s()})(rt,function(){return t.importState=function(i){var r=new t;return r.importState(i),r},t;function t(){return(function(i){var r=0,o=0,a=0,h=1;i.length==0&&(i=[+new Date]);var c=s();r=c(" "),o=c(" "),a=c(" ");for(var u=0;u<i.length;u++)r-=c(i[u]),r<0&&(r+=1),o-=c(i[u]),o<0&&(o+=1),a-=c(i[u]),a<0&&(a+=1);c=null;var p=function(){var m=2091639*r+h*23283064365386963e-26;return r=o,o=a,a=m-(h=m|0)};return p.next=p,p.uint32=function(){return p()*4294967296},p.fract53=function(){return p()+(p()*2097152|0)*11102230246251565e-32},p.version="Alea 0.9",p.args=i,p.exportState=function(){return[r,o,a,h]},p.importState=function(m){r=+m[0]||0,o=+m[1]||0,a=+m[2]||0,h=+m[3]||0},p})(Array.prototype.slice.call(arguments))}function s(){var i=4022871197,r=function(o){o=o.toString();for(var a=0;a<o.length;a++){i+=o.charCodeAt(a);var h=.02519603282416938*i;i=h>>>0,h-=i,h*=i,i=h>>>0,h-=i,i+=h*4294967296}return(i>>>0)*23283064365386963e-26};return r.version="Mash 0.9",r}})})(q)),q.exports}var at=ot();const ve=nt(at);class k{constructor(e){this.seed="",this.rng=ve(),e&&this.reset(e)}reset(e){this.seed=e,this.rng=ve(e),k.debug&&console.log(`PRNG.reset() with seed: ${e}`)}random(){const e=this.rng();return k.debug&&console.log(`PRNG.random(): ${e}`),e}randomInt(e,t){const s=Math.floor(this.random()*(t-e+1))+e;return k.debug&&console.log(`PRNG.randomInt(${e}, ${t}): ${s}`),s}randomChoice(e){if(e.length===0)throw new Error("Cannot choose from empty array");const t=this.randomInt(0,e.length-1),s=e[t];return k.debug&&console.log(`PRNG.randomChoice(array[${e.length}]): index=${t}, value=${s}`),s}randomFloat(e,t){const s=this.random()*(t-e)+e;return k.debug&&console.log(`PRNG.randomFloat(${e}, ${t}): ${s}`),s}randomBoolean(e=.5){const t=this.random()<e;return k.debug&&console.log(`PRNG.randomBoolean(${e}): ${t}`),t}}k.debug=!1;const Ce=60,ht=1e3,ct=Ce*ht;function N(n){return~~(n*ct/1e3)}const lt={MAX_ITERATIONS:1e3};class dt{constructor(){this.timers=new Map,this.nextId=1,this.currentTick=0,this.updateStartTick=0,this.isUpdating=!1}setTimeout(e,t){const s=this.nextId++,i=this.isUpdating?this.updateStartTick:this.currentTick;return this.timers.set(s,{id:s,callback:e,targetTick:i+t,isActive:!0}),s}setInterval(e,t){const s=this.nextId++,i=this.isUpdating?this.updateStartTick:this.currentTick;return this.timers.set(s,{id:s,callback:e,targetTick:i+t,interval:t,isActive:!0}),s}clearTimer(e){return this.timers.delete(e)}update(e,t){this.updateStartTick=this.currentTick,this.currentTick=t,this.isUpdating=!0;let s=!0,i=lt.MAX_ITERATIONS,r=0;for(;s&&r<i;){s=!1,r++;const o=[];for(const a of this.timers.values())a.isActive&&this.currentTick>=a.targetTick&&o.push(a);if(o.sort((a,h)=>a.targetTick!==h.targetTick?a.targetTick-h.targetTick:a.id-h.id),o.length>0){s=!0;for(const a of o)try{a.callback()}catch(h){console.error(`Timer ${a.id} failed:`,h)}for(const a of o)a.interval!==void 0&&a.isActive?a.interval===0?(a.targetTick=this.currentTick+1,s=!1):a.targetTick+=a.interval:this.timers.delete(a.id)}}this.isUpdating=!1}reset(){this.timers.clear(),this.currentTick=0}getActiveTimerCount(){return Array.from(this.timers.values()).filter(e=>e.isActive).length}getTimerInfo(){return Array.from(this.timers.values()).map(e=>({id:e.id,targetTick:e.targetTick,ticksRemaining:Math.max(0,e.targetTick-this.currentTick),isRepeating:e.interval!==void 0,isActive:e.isActive}))}pauseTimer(e){const t=this.timers.get(e);return t?(t.isActive=!1,!0):!1}resumeTimer(e){const t=this.timers.get(e);return t?(t.isActive=!0,!0):!1}getTotalTimerCount(){return this.timers.size}}class xe{constructor(){this.dataQueue=[]}queueInput(e,t){this.dataQueue.push({inputType:e,data:t,timestamp:Date.now()})}getNextEvents(e){if(this.dataQueue.length===0)return[];const t=this.dataQueue.map(s=>({type:K.USER_INPUT,tick:e,timestamp:s.timestamp,inputType:s.inputType,params:s.data}));return this.dataQueue=[],t}hasMoreEvents(){return this.dataQueue.length>0}reset(){this.dataQueue.length=0}getQueueLength(){return this.dataQueue.length}getQueuedData(){return this.dataQueue.map(e=>e.data)}removeData(e){const t=this.dataQueue.length;return this.dataQueue=this.dataQueue.filter(s=>!e(s.data)),t-this.dataQueue.length}clear(){this.dataQueue.length=0}}var H;(function(n){n.POINTS_CHANGED="pointsChanged"})(H||(H={}));class Q extends Y{constructor(){super(),this.gridMap=new Map,this.sourceMap=new Map}add(e,t){const s=this.getKey(e),i=t.getCollisionSourceId(),r=this.gridMap.get(s)||[];for(const o of r)if(o.getCollisionSourceId()===i)return!1;return this.gridMap.has(s)||this.gridMap.set(s,[]),this.gridMap.get(s).push(t),this.sourceMap.has(i)||this.sourceMap.set(i,new Set),this.sourceMap.get(i).add(s),this.emit(H.POINTS_CHANGED),!0}remove(e,t){const s=this.getKey(e),i=this.gridMap.get(s);if(!i)return!1;const r=t.getCollisionSourceId(),o=i.length;for(let c=i.length-1;c>=0;c--)if(i[c].getCollisionSourceId()===r){i.splice(c,1);break}i.length===0&&this.gridMap.delete(s);const a=this.sourceMap.get(r);a&&(a.delete(s),a.size===0&&this.sourceMap.delete(r));const h=i.length<o;return h&&this.emit(H.POINTS_CHANGED),h}removeSource(e){const t=e.getCollisionSourceId(),s=this.sourceMap.get(t);if(!s||s.size===0)return!1;for(const i of s){const r=this.gridMap.get(i);if(r){const o=r.filter(a=>a.getCollisionSourceId()!==t);o.length===0?this.gridMap.delete(i):this.gridMap.set(i,o)}}return this.sourceMap.delete(t),this.emit(H.POINTS_CHANGED),!0}containsPoint(e){const t=this.getKey(e);return this.gridMap.get(t)||[]}clear(){this.gridMap.clear(),this.sourceMap.clear(),this.emit(H.POINTS_CHANGED)}getKey(e){return`${e.x},${e.y}`}}class l{constructor(e,t){this.x=e,this.y=t}add(e){return new l(this.x+e.x,this.y+e.y)}subtract(e){return new l(this.x-e.x,this.y-e.y)}scale(e){return new l(this.x*e,this.y*e)}dot(e){return this.x*e.x+this.y*e.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}distance(e){return l.distance(this,e)}normalize(){const e=this.length();return e===0?new l(0,0):new l(this.x/e,this.y/e)}rotate(e){const t=Math.cos(e),s=Math.sin(e);return new l(this.x*t-this.y*s,this.x*s+this.y*t)}angle(){return Math.atan2(this.y,this.x)}angleBetween(e){return Math.atan2(e.y-this.y,e.x-this.x)}clone(){return new l(this.x,this.y)}toString(){return`(${this.x}, ${this.y})`}serialize(){return{x:this.x,y:this.y}}static deserialize(e){return new l(e.x,e.y)}static distance(e,t){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}static distanceSquared(e,t){const s=e.x-t.x,i=e.y-t.y;return s*s+i*i}static isWithinDistance(e,t,s){return l.distanceSquared(e,t)<=s*s}static normalizeAngle(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}static angleDifference(e,t){e=l.normalizeAngle(e),t=l.normalizeAngle(t);let s=t-e;return s>Math.PI&&(s-=2*Math.PI),s<-Math.PI&&(s+=2*Math.PI),s}}var Z;(function(n){n.STATE_CHANGE="stateChange"})(Z||(Z={}));let ut=class extends Y{constructor(e){super(),this.gameObjectGroups=new Map,this.totalTicks=0,this.state=S.READY,this.seed="",this.gameConfig={},this.prng=new k,this.timer=new dt,this.recorder=void 0,this.loader=e.loader,this.platform=e.platform,this.assetLoader=e.assetLoader||new st(e.loader,e.platform.rendering,e.platform.audio),this.eventManager=new it(new xe,this),this.collisionTree=new Q}setState(e){const t=this.state;this.state=e,this.emit(Z.STATE_CHANGE,e,t)}async reset(e){this.gameConfig=e,e.prngSeed!==void 0&&(this.seed=e.prngSeed),this.setState(S.READY),this.prng.reset(this.seed),this.totalTicks=0,this.gameObjectGroups.clear(),this.timer.reset(),this.eventManager.reset(),this.collisionTree.clear(),this.assetLoader&&await this.assetLoader.preloadAssets(),await this.setup(e)}start(){if(this.state!==S.READY)throw new Error(`Cannot start game: expected READY state, got ${this.state}`);this.setState(S.PLAYING)}pause(){if(this.state!==S.PLAYING)throw new Error(`Cannot pause game: expected PLAYING state, got ${this.state}`);this.setState(S.PAUSED)}resume(){if(this.state!==S.PAUSED)throw new Error(`Cannot resume game: expected PAUSED state, got ${this.state}`);this.setState(S.PLAYING)}end(){if(this.state!==S.PLAYING&&this.state!==S.PAUSED)throw new Error(`Cannot end game: expected PLAYING or PAUSED state, got ${this.state}`);this.setState(S.ENDED)}update(e){if(this.state===S.PLAYING){this.totalTicks+=e,this.recorder&&this.recorder.recordFrameUpdate(e,this.totalTicks),this.eventManager.update(e,this.totalTicks),this.timer.update(e,this.totalTicks);for(const[t,s]of this.gameObjectGroups)s.update(e,this.totalTicks)}}registerGameObject(e,t){const s=t||e.getType();let i=this.gameObjectGroups.get(s);i||(i=new F,this.gameObjectGroups.set(s,i)),i.add(e)}getGameObjectGroup(e){return this.gameObjectGroups.get(e)}getRegisteredTypes(){return Array.from(this.gameObjectGroups.keys())}getState(){return this.state}getSeed(){return this.seed}getGameConfig(){return this.gameConfig}getTotalTicks(){return this.totalTicks}getPRNG(){return this.prng}clearDestroyedGameObjects(){let e=0;for(const t of this.gameObjectGroups.values())e+=t.clearDestroyed();return e}setTimeout(e,t){return this.timer.setTimeout(e,t)}setInterval(e,t){return this.timer.setInterval(e,t)}clearTimer(e){return this.timer.clearTimer(e)}getTimer(){return this.timer}getEventManager(){return this.eventManager}setGameRecorder(e){this.recorder=e,this.eventManager.setRecorder(e)}getCollisionTree(){return this.collisionTree}getLoader(){return this.loader}getPlatform(){return this.platform}getAssetLoader(){return this.assetLoader}};var I;(function(n){n.POSITION_CHANGED="positionChanged",n.HEALTH_CHANGED="healthChanged",n.MAX_HEALTH_CHANGED="maxHealthChanged",n.DESTROYED="destroyed",n.SIZE_CHANGED="sizeChanged",n.VELOCITY_CHANGED="velocityChanged",n.ROTATION_CHANGED="rotationChanged"})(I||(I={}));class W extends Y{constructor(e,t,s,i=0,r){super(),this.isRepaintNeeded=!0,this.id=e,this.position=t,this.size=s,this.velocity=new l(0,0),this.rotation=0,this.health=i,this.maxHealth=i,this.destroyed=!1,this.engine=r,r&&r.registerGameObject(this)}update(e,t){if(this.destroyed)return;const s=this.velocity.scale(e),i=this.position;this.position=this.position.add(s),(i.x!==this.position.x||i.y!==this.position.y)&&(this.isRepaintNeeded=!0)}getPosition(){return this.position}setPosition(e){const t=this.position;this.position=e,(t.x!==e.x||t.y!==e.y)&&(this.isRepaintNeeded=!0),this.emit(I.POSITION_CHANGED,this,t,e)}getSize(){return this.size}setSize(e){(this.size.x!==e.x||this.size.y!==e.y)&&(this.size=e,this.isRepaintNeeded=!0)}getVelocity(){return this.velocity}setVelocity(e){(this.velocity.x!==e.x||this.velocity.y!==e.y)&&(this.velocity=e,this.isRepaintNeeded=!0)}getRotation(){return this.rotation}setRotation(e){this.rotation!==e&&(this.rotation=e,this.isRepaintNeeded=!0)}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}setMaxHealth(e){const t=this.maxHealth;this.maxHealth=e,this.maxHealth!==t&&(this.isRepaintNeeded=!0,this.emit(I.MAX_HEALTH_CHANGED,this,t,e))}setHealth(e){const t=this.health;this.health=Math.max(0,Math.min(this.maxHealth,e)),this.health!==t&&(this.isRepaintNeeded=!0,this.emit(I.HEALTH_CHANGED,this,this.health,this.maxHealth)),this.health===0&&(this.destroyed=!0,this.emit(I.DESTROYED,this))}takeDamage(e){const t=this.health;this.health=Math.max(0,this.health-e),this.health!==t&&(this.isRepaintNeeded=!0,this.emit(I.HEALTH_CHANGED,this,this.health,this.maxHealth)),this.health===0&&(this.destroyed=!0,this.emit(I.DESTROYED,this))}heal(e){const t=this.health;this.health=Math.min(this.maxHealth,this.health+e),this.health!==t&&(this.isRepaintNeeded=!0,this.emit(I.HEALTH_CHANGED,this,this.health,this.maxHealth))}isDestroyed(){return this.destroyed}destroy(){this.destroyed=!0,this.isRepaintNeeded=!0,this.emit(I.DESTROYED,this)}get needsRepaint(){return this.isRepaintNeeded}set needsRepaint(e){this.isRepaintNeeded=e}getId(){return this.id}getEngine(){return this.engine}registerWithEngine(e){this.engine=e,e.registerGameObject(this)}getCollisionSourceId(){return this.getId()}serialize(){return{position:{x:this.position.x,y:this.position.y},size:{x:this.size.x,y:this.size.y},velocity:{x:this.velocity.x,y:this.velocity.y},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,isDestroyed:this.destroyed}}static deserialize(e){throw new Error("GameObject.deserialize must be implemented by subclasses")}}W.debug=!1;class pt{constructor(){this.typeRegistry=new Map}registerType(e,t){this.typeRegistry.set(e,t)}serialize(e){if(e==null||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return{__type:"Array",__data:e.map(t=>this.serialize(t))};if(e&&typeof e=="object"&&typeof e.serialize=="function")return{__type:this.getTypeName(e),__data:this.serialize(e.serialize())};if(e&&typeof e=="object"&&e.constructor===Object){const t={};for(const[s,i]of Object.entries(e))t[s]=this.serialize(i);return{__type:"Object",__data:t}}if(e&&typeof e=="object"){const t={};for(const[s,i]of Object.entries(e))t[s]=this.serialize(i);return{__type:"Object",__data:t}}return e}deserialize(e){if(e==null||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(e&&typeof e=="object"&&"__type"in e&&"__data"in e){const t=e;if(typeof t.__type!="string")throw new Error("Invalid serialized data: __type must be a string");if(t.__type.includes("function")||t.__type.includes("eval")||t.__type.includes("constructor")||t.__type.includes("__proto__")||t.__type.includes("prototype"))throw new Error(`Unsafe type name: ${t.__type}`);switch(t.__type){case"Array":return t.__data.map(s=>this.deserialize(s));case"Object":{const s={};for(const[i,r]of Object.entries(t.__data))s[i]=this.deserialize(r);return s}default:{const s=this.typeRegistry.get(t.__type);if(s){const i=this.deserialize(t.__data);return s.deserialize(i)}return this.deserialize(t.__data)}}}if(e&&typeof e=="object"){const t={};for(const[s,i]of Object.entries(e))t[s]=this.deserialize(i);return t}return e}getTypeName(e){for(const[t,s]of this.typeRegistry)if(e instanceof s)return t;return e.constructor.name||"Object"}getRegisteredTypes(){return Array.from(this.typeRegistry.keys())}clearRegistry(){this.typeRegistry.clear()}}const J=new pt;class M{constructor(e,t){this.id=e,this.rendering=t}addChild(e){return this.rendering.addChild(this.id,e.id),this}removeChild(e){return this.rendering.removeChild(this.id,e.id),this}destroy(){this.rendering.destroyNode(this.id)}setPosition(e,t){return this.rendering.setPosition(this.id,e,t),this}setRotation(e){return this.rendering.setRotation(this.id,e),this}setScale(e,t){return this.rendering.setScale(this.id,e,t??e),this}getRotation(){return this.rendering.getRotation(this.id)}getScale(){return this.rendering.getScale(this.id)}setAnchor(e,t){return this.rendering.setAnchor(this.id,e,t),this}setAlpha(e){return this.rendering.setAlpha(this.id,e),this}setVisible(e){return this.rendering.setVisible(this.id,e),this}setZIndex(e){return this.rendering.setZIndex(this.id,e),this}setSize(e,t){return this.rendering.setSize(this.id,e,t),this}getSize(){return this.rendering.getSize(this.id)}setTint(e){return this.rendering.setTint(this.id,e),this}setBlendMode(e){return this.rendering.setBlendMode(this.id,e),this}setTextureFiltering(e){return this.rendering.setTextureFiltering(this.id,e),this}getBounds(){return this.rendering.getBounds(this.id)}setSprite(e){return this.rendering.setSprite(this.id,e),this}setAnimatedSprite(e,t){return this.rendering.setAnimatedSprite(this.id,e,t),this}playAnimation(e=!1){return this.rendering.playAnimation(this.id,e),this}stopAnimation(){return this.rendering.stopAnimation(this.id),this}setAnimationCompleteCallback(e){return this.rendering.setAnimationCompleteCallback(this.id,e),this}drawRectangle(e,t,s,i,r,o,a){return this.rendering.drawRectangle(this.id,e,t,s,i,r,o,a),this}drawCircle(e,t,s,i,r,o){return this.rendering.drawCircle(this.id,e,t,s,i,r,o),this}drawPolygon(e,t,s,i){return this.rendering.drawPolygon(this.id,e,t,s,i),this}drawRoundRect(e,t,s,i,r,o,a,h){return this.rendering.drawRoundRect(this.id,e,t,s,i,r,o,a,h),this}drawLine(e,t,s,i,r,o){return this.rendering.drawLine(this.id,e,t,s,i,r,o),this}drawPolyline(e,t,s){return this.rendering.drawPolyline(this.id,e,t,s),this}clearGraphics(){return this.rendering.clearGraphics(this.id),this}getId(){return this.id}getNodeId(){return this.id}getRendering(){return this.rendering}}class oe{constructor(e){this.itemNodes=new Map,this.items=new Map,this.gameState=S.READY,this.gameNode=e,this.rendering=e.getRendering()}updateGameState(e){this.gameState=e}add(e){try{const t=this.getId(e);if(this.itemNodes.has(t)){this.update(e);return}const s=this.create(e);this.gameNode.addChild(s),this.itemNodes.set(t,s),this.items.set(t,e),this.updateNode(s,e)}catch(t){console.error(`Error adding item in ${this.constructor.name}:`,t)}}update(e){try{const t=this.getId(e),s=this.itemNodes.get(t);s?(this.updateNode(s,e),this.items.set(t,e)):this.add(e)}catch(t){console.error(`Error updating item in ${this.constructor.name}:`,t)}}remove(e){try{const t=this.itemNodes.get(e);t&&(this.gameNode.removeChild(t),t.destroy(),this.itemNodes.delete(e),this.items.delete(e))}catch(t){console.error(`Error removing item in ${this.constructor.name}:`,t)}}setItems(e){try{const t=Array.from(this.itemNodes.keys()),s=new Set;for(const i of e){const r=this.getId(i);s.add(r),this.itemNodes.has(r)?this.update(i):this.add(i)}for(const i of t)s.has(i)||this.remove(i)}catch(t){console.error(`Error setting items in ${this.constructor.name}:`,t)}}calculateHealthBasedAlpha(e,t,s=t*.5){return e<=0?.3:e>=s||e>=t?1:.3+.7*(e/s)}createRectangle(e,t,s,i,r){const o=this.rendering.createNode(),a=new M(o,this.rendering);return i=i??-e/2,r=r??-t/2,this.rendering.drawRectangle(o,i,r,e,t,s),a}createCircle(e,t,s=0,i=0){const r=this.rendering.createNode(),o=new M(r,this.rendering);return this.rendering.drawCircle(r,s,i,e,t),o}createPolygon(e,t){const s=this.rendering.createNode(),i=new M(s,this.rendering);return this.rendering.drawPolygon(s,e,t),i}createBorderRectangle(e,t,s,i,r=1){const o=this.rendering.createNode(),a=new M(o,this.rendering);return this.rendering.drawRectangle(o,0,0,e,t,void 0,i,s),a.setAlpha(r),a}createStandardNode(e,t,s=void 0,i){const r=this.rendering.createNode(),o=new M(r,this.rendering);return o.setPosition(e,t),s!==void 0&&o.setRotation(s),o.addChild(i),o}updateNode(e,t){typeof t=="object"&&t!==null&&"needsRepaint"in t&&t.needsRepaint?(this.repaintNode(e,t),t.needsRepaint=!1):(typeof t!="object"||t===null||!("needsRepaint"in t))&&this.repaintNode(e,t)}repaintNode(e,t){}clear(){const e=Array.from(this.itemNodes.entries());for(const[t,s]of e)this.gameNode.removeChild(s),s.destroy(),this.itemNodes.delete(t),this.items.delete(t)}getNode(e){return this.itemNodes.get(e)}getItem(e){return this.items.get(e)}getAllItems(){return this.items}rerender(){try{for(const[e,t]of this.items.entries()){const s=this.itemNodes.get(e);s&&this.updateNode(s,t)}}catch(e){console.error(`Error rerendering items in ${this.constructor.name}:`,e)}}}var U;(function(n){n.POINTER_MOVE="pointerMove",n.POINTER_CLICK="pointerClick",n.VIEWPORT_MOVED="viewportMoved",n.VIEWPORT_ZOOMED="viewportZoomed"})(U||(U={}));let ke=class Me extends Y{constructor(e,t){super(),this.options=e,this.gameEngine=null,this.renderers=new Map,this.updateCallback=null,this.handlePointerMove=s=>{const i=this.rendering.screenToWorld(this.viewportNodeId,s.x,s.y),r=new l(i.x,i.y);this.emit(U.POINTER_MOVE,r)},this.handleClick=s=>{const i=this.rendering.screenToWorld(this.viewportNodeId,s.x,s.y),r=new l(i.x,i.y);this.emit(U.POINTER_CLICK,r)},this.handleGameStateChange=(s,i)=>{for(const r of this.renderers.values())try{r.updateGameState(s)}catch(o){console.error("Error updating renderer game state:",o)}},this.rendering=t.rendering,this.audio=t.audio,this.input=t.input,this.initialWidth=e.width,this.initialHeight=e.height,this.options={...Me.DEFAULT_OPTIONS,...e}}async initialize(){const e=this.rendering.createNode(),t=this.rendering.createNode(),s=this.rendering.createNode();this.viewportNode=new M(e,this.rendering),this.gameNode=new M(t,this.rendering),this.hudNode=new M(s,this.rendering),this.viewportNodeId=e,this.viewportNode.addChild(this.gameNode),this.rendering.setViewport(this.viewportNodeId,{screenWidth:this.options.width,screenHeight:this.options.height,worldWidth:this.options.worldWidth,worldHeight:this.options.worldHeight,enableDrag:this.options.enableDrag,enablePinch:this.options.enablePinch,enableZoom:this.options.enableWheel,clampWheel:this.options.enableWheel,minScale:this.options.minZoom,maxScale:this.options.maxZoom}),this.rendering.setViewportPosition(this.viewportNodeId,this.options.worldWidth/2,this.options.worldHeight/2),this.options.initialZoom&&this.rendering.setViewportZoom(this.viewportNodeId,this.options.initialZoom),this.setupEventListeners(),this.setupUpdateLoop()}setupEventListeners(){this.input.onPointerMove(e=>this.handlePointerMove(e)),this.input.onClick(e=>this.handleClick(e))}setupUpdateLoop(){this.rendering.onTick(e=>{this.update(e)})}registerRenderer(e,t){this.renderers.set(e,t)}unregisterRenderer(e){this.renderers.delete(e)}clearRenderers(){for(const e of this.renderers.values())try{e.clear()}catch(t){console.error("Error clearing renderer:",t)}}getGameEngine(){return this.gameEngine}setGameEngine(e){this.gameEngine&&this.gameEngine.off(Z.STATE_CHANGE,this.handleGameStateChange),this.gameEngine=e,this.gameEngine&&this.gameEngine.on(Z.STATE_CHANGE,this.handleGameStateChange),this.clearRenderers(),this.setupRenderers(),this.gameEngine&&this.render(0)}update(e){this.gameEngine&&this.gameEngine.update(e),this.render(e)}moveViewportTo(e,t,s=!1){this.rendering.setViewportPosition(this.viewportNodeId,e,t);const i=this.rendering.getViewportPosition(this.viewportNodeId);this.emit(U.VIEWPORT_MOVED,new l(i.x,i.y))}setZoom(e,t=!1){this.rendering.setViewportZoom(this.viewportNodeId,e);const s=this.rendering.getViewportZoom(this.viewportNodeId);this.emit(U.VIEWPORT_ZOOMED,s)}getViewportCenter(){const e=this.rendering.getViewportPosition(this.viewportNodeId);return new l(e.x,e.y)}getZoom(){return this.rendering.getViewportZoom(this.viewportNodeId)}worldToScreen(e){const t=this.rendering.worldToScreen(this.viewportNodeId,e.x,e.y);return new l(t.x,t.y)}screenToWorld(e){const t=this.rendering.screenToWorld(this.viewportNodeId,e.x,e.y);return new l(t.x,t.y)}resize(e,t){if(this.rendering.resize(e,t),this.options.scaleWithResize){const o=e/this.initialWidth,a=t/this.initialHeight,h=Math.min(o,a);this.gameNode.setScale(h),this.gameNode.setPosition((e-this.initialWidth*h)/2,(t-this.initialHeight*h)/2)}else this.options.width=e,this.options.height=t;const s=this.options.worldWidth/this.options.worldHeight,i=e/t;let r;i>s?r=t/this.options.worldHeight:r=e/this.options.worldWidth,r=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,r)),this.rendering.setViewportZoom(this.viewportNodeId,r),this.rendering.setViewportPosition(this.viewportNodeId,this.options.worldWidth/2,this.options.worldHeight/2)}destroy(){this.input.removeAllListeners(),this.clearListeners(),this.viewportNode&&this.viewportNode.destroy(),this.hudNode&&this.hudNode.destroy()}getGameNode(){return this.gameNode}getHudNode(){return this.hudNode}getOptions(){return{...this.options}}};ke.DEFAULT_OPTIONS={backgroundColor:1973790,resolution:1,antialias:!0,minZoom:.1,maxZoom:5,initialZoom:1,clampBuffer:100,enableDrag:!0,enablePinch:!0,enableWheel:!0,enableDecelerate:!0,scaleWithResize:!1};function De(n){const e=n.startsWith("#")?n.slice(1):n;return Number.parseInt(e,16)}var Pe;(function(n){n.NORMAL="normal",n.ADD="add",n.MULTIPLY="multiply",n.SCREEN="screen"})(Pe||(Pe={}));var Ne;(function(n){n.LINEAR="linear",n.NEAREST="nearest"})(Ne||(Ne={}));var Ae;(function(n){n.SUSPENDED="suspended",n.RUNNING="running",n.CLOSED="closed"})(Ae||(Ae={}));const T=44100;var _=(n=>(n.EAT="eat",n.GAME_OVER="gameOver",n.ARENA_RESET="arenaReset",n.INVINCIBLE="invincible",n.INVERTED="inverted",n.SLOW_DOWN="slowDown",n))(_||{});function gt(n){const t=n.createBuffer(1,Math.floor(T*.25),T),s=t.getChannelData(0);for(let i=0;i<t.length;i++){const r=i/T,o=Math.exp(-r*6),a=800+Math.sin(r*100)*200,h=Math.sin(2*Math.PI*a*r)*.4,c=(Math.random()-.5)*2*.3,u=Math.sin(2*Math.PI*a*1.5*r)*.2,p=Math.sin(2*Math.PI*a*2.2*r)*.1;s[i]=(h+c+u+p)*o*.5}return t}function ft(n){const t=n.createBuffer(1,Math.floor(T*.4),T),s=t.getChannelData(0);for(let i=0;i<t.length;i++){const r=i/T,o=Math.exp(-r*5),a=400-r*200,h=Math.sin(2*Math.PI*a*r)*.5,c=(Math.random()-.5)*2*.3,u=Math.sin(2*Math.PI*(a*.5)*r)*.2;s[i]=(h+c+u)*o*.6}return t}function mt(n){const t=n.createBuffer(1,Math.floor(T*.3),T),s=t.getChannelData(0);for(let i=0;i<t.length;i++){const r=i/T,o=Math.exp(-r*3),a=800,h=Math.sin(2*Math.PI*a*r)*.4,c=Math.sin(2*Math.PI*a*2.5*r)*.2,u=Math.sin(2*Math.PI*a*4*r)*.1,p=Math.sin(2*Math.PI*a*5.5*r)*.05,m=a+Math.sin(r*10)*50,g=Math.sin(2*Math.PI*m*r)*.1;s[i]=(h+c+u+p+g)*o*.6}return t}function yt(n){const t=n.createBuffer(1,Math.floor(T*.8),T),s=t.getChannelData(0);for(let i=0;i<t.length;i++){const o=i/T%.8,a=Math.sin(2*Math.PI*523*o*6)*.25+Math.sin(2*Math.PI*659*o*6)*.2+Math.sin(2*Math.PI*784*o*6)*.2,h=Math.sin(2*Math.PI*659*o*8)*.2+Math.sin(2*Math.PI*784*o*8)*.15+Math.sin(2*Math.PI*1047*o*8)*.15,c=Math.sin(2*Math.PI*784*o*10)*.15+Math.sin(2*Math.PI*1047*o*10)*.1+Math.sin(2*Math.PI*1319*o*10)*.1,u=Math.sin(2*Math.PI*131*o*4)*.3+Math.sin(2*Math.PI*165*o*4)*.25+Math.sin(2*Math.PI*196*o*4)*.25,p=Math.sin(2*Math.PI*1047*o*12)*.15+Math.sin(2*Math.PI*1319*o*12)*.1+Math.sin(2*Math.PI*1568*o*12)*.1,m=Math.sin(o*Math.PI*6)*.5+.5,g=(a+h+c+u+p)*m*.25;s[i]=g}return t}function Et(n){const t=n.createBuffer(1,Math.floor(T*3),T),s=t.getChannelData(0);for(let i=0;i<t.length;i++){const o=i/T%3,a=Math.sin(2*Math.PI*55*o)*.4+Math.sin(2*Math.PI*73*o)*.3,h=Math.sin(2*Math.PI*220*o)*.2+Math.sin(2*Math.PI*261*o)*.15+Math.sin(2*Math.PI*293*o)*.15,c=Math.sin(2*Math.PI*233*o)*.1+Math.sin(2*Math.PI*277*o)*.1,u=Math.sin(2*Math.PI*110*o*.5)*.3,p=Math.sin(o*Math.PI*.5)*.3+.7;s[i]=(a+h+c+u)*p*.3}return t}function wt(n){const t=n.createBuffer(1,Math.floor(T*.5),T),s=t.getChannelData(0);for(let i=0;i<t.length;i++){const r=i/T,o=Math.exp(-r*4),a=Math.sin(2*Math.PI*523*r)*.3+Math.sin(2*Math.PI*659*r)*.25+Math.sin(2*Math.PI*784*r)*.25+Math.sin(2*Math.PI*1047*r)*.2,h=Math.sin(2*Math.PI*1319*r)*.15+Math.sin(2*Math.PI*1568*r)*.1;s[i]=(a+h)*o*.6}return t}function St(n){n.loadSoundFromBuffer("eat",gt(n)),n.loadSoundFromBuffer("gameOver",ft(n)),n.loadSoundFromBuffer("arenaReset",mt(n)),n.loadSoundFromBuffer("invincible",yt(n)),n.loadSoundFromBuffer("inverted",Et(n)),n.loadSoundFromBuffer("slowDown",wt(n))}var y=(n=>(n.UP="up",n.DOWN="down",n.LEFT="left",n.RIGHT="right",n))(y||{}),w=(n=>(n.INVINCIBLE="invincible",n.INVERTED_CONTROLS="inverted_controls",n.SLOW_DOWN="slow_down",n.DARKNESS="darkness",n))(w||{});const d={ARENA_SIZE:50,BLOCK_SIZE:12,INITIAL_SNAKE_LENGTH:2,MAX_SNAKE_LENGTH:2400,MAX_OBSTACLES:100,APPLES_TO_LEVEL_UP:8,INITIAL_MOVE_INTERVAL:N(100),SPEED_INCREASE_AMOUNT:N(10),SPEED_INCREASE_INTERVAL:N(1e4),MIN_MOVE_INTERVAL:N(50),OBSTACLE_SPAWN_INTERVAL:N(500),CONSUMABLE_SPAWN_INTERVAL:N(100),POWER_UP_SPAWN_INTERVAL:N(1e3),POWER_UP_SPAWN_CHANCE:.1,POWER_UP_DURATION:N(2e4),POWER_UP_EFFECT_DURATION:N(6e3),SLOW_DOWN_EFFECT_DURATION:N(1e4)},$=new l(25,42),It=y.RIGHT,Tt=[{level:1,obstacles:[],maxSnakeLength:d.MAX_SNAKE_LENGTH},{level:2,obstacles:vt(),maxSnakeLength:d.MAX_SNAKE_LENGTH-d.MAX_OBSTACLES}];function vt(){const n=[];for(let e=10;e<40;e++)e!==25&&(n.push(new l(e,5)),n.push(new l(e,45)));for(let e=15;e<35;e++)e!==25&&(n.push(new l(5,e)),n.push(new l(45,e)));return n.slice(0,d.MAX_OBSTACLES)}const L={SNAKE:16744448,CONSUMABLE:16711680,OBSTACLE:65280,GRID:65280,POWER_UP:16766720,SNAKE_INVERTED:8388736,SNAKE_SLOW:65535};class P extends W{static TypeName="Obstacle";static idCounter=0;isPreview;spawnTick;points;isFlashing;repaintPoints=!1;flashTimer;flashTimerId;get pointsNeedRepaint(){return this.repaintPoints}set pointsNeedRepaint(e){this.repaintPoints=e}constructor(e,t=!1,s,i,r){const o=r||`obstacle_${++P.idCounter}`;super(o,e,new l(1,1),1),this.isPreview=t,this.spawnTick=s||0,this.points=i||[{point:new l(e.x,e.y)}],this.isFlashing=!1}startFlashing(e,t){this.flashTimer=e,this.flashTimerId=e.setInterval(()=>{this.isFlashing=!this.isFlashing,this.needsRepaint=!0},t)}stopFlashing(){this.flashTimer&&this.flashTimerId!==void 0&&(this.flashTimer.clearTimer(this.flashTimerId),this.flashTimerId=void 0),this.isFlashing=!1}getType(){return P.TypeName}isPreviewObstacle(){return this.isPreview}setPreview(e){this.isPreview=e,this.needsRepaint=!0}getSpawnTick(){return this.spawnTick}hasSpawnTick(){return this.spawnTick!==void 0}isFlashingActive(){return this.isFlashing}getPoints(){return this.points.map(e=>({...e,point:new l(e.point.x,e.point.y)}))}getPointsRef(){return this.points}getAllPointPositions(){return this.points.map(e=>new l(e.point.x,e.point.y))}setPoints(e){this.points=e,this.emit("pointsReplaced",this,this.points),this.needsRepaint=!0,this.repaintPoints=!0}addPoint(e){this.points.push(e),this.emit("pointAdded",this,e),this.needsRepaint=!0,this.repaintPoints=!0}removePoint(e){if(e>=0&&e<this.points.length){const t=this.points[e];this.points.splice(e,1),this.emit("pointRemoved",this,t),this.needsRepaint=!0,this.repaintPoints=!0}}containsPoint(e){return this.points.some(t=>t.point.x===e.x&&t.point.y===e.y)}getPointCount(){return this.points.length}activateFromPreview(){this.stopFlashing(),this.isPreview=!1,this.spawnTick=void 0,this.needsRepaint=!0}serialize(){return{position:{x:this.position.x,y:this.position.y},size:{x:this.size.x,y:this.size.y},velocity:{x:this.velocity.x,y:this.velocity.y},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,isDestroyed:this.destroyed,isPreview:this.isPreview,spawnTick:this.spawnTick,points:this.points.map(e=>({x:e.point.x,y:e.point.y})),isFlashing:this.isFlashing}}static deserialize(e){const t=e.points?e.points.map(i=>({point:new l(i.x,i.y)})):void 0,s=new P(new l(e.position.x,e.position.y),e.isPreview,e.spawnTick,t,void 0);return s.setVelocity(new l(e.velocity.x,e.velocity.y)),s.setRotation(e.rotation),s.health=e.health,s.maxHealth=e.maxHealth,s.destroyed=e.isDestroyed,s.isFlashing=e.isFlashing||!1,s}}J.registerType(P.TypeName,P);class z{gameEngine;prng;_isStatic=!1;usesPreviewObstacles=!0;obstacleGroup;previewObstacleGroup;loadedPromise;loadedResolver;constructor(e){this.gameEngine=e,this.prng=e.getPrng()}isStatic(){return this._isStatic}spawnObstacles(e){const t=[];if(!this.obstacleGroup)return console.error(`${this.name}: obstacleGroup not set`),{collidesWith:t};if(this.usesPreviewObstacles&&!this.previewObstacleGroup)return console.error(`${this.name}: previewObstacleGroup not set`),{collidesWith:t};const s=this.usesPreviewObstacles?this.activatePreviewObstacles(e):!1,i=this.spawnNewObstacles(e,s);return t.push(...i),{collidesWith:t}}activatePreviewObstacles(e){if(!this.previewObstacleGroup)return!1;const t=this.previewObstacleGroup.getAllActive();let s=!1;return t.length>0&&t.forEach(i=>{i.getPointsRef().every(o=>e.snakeGrid.containsPoint(o.point).length===0)&&(i.activateFromPreview(),this.obstacleGroup.add(i),this.previewObstacleGroup.remove(i),i.getPointsRef().forEach(o=>{e.collisionGrid.add(o.point,i)}),i.on(I.DESTROYED,()=>{e.collisionGrid.removeSource(i)}),s=!0)}),s}reset(){this.loadedPromise=new Promise(e=>{this.loadedResolver=e})}async setOnStrategyLoaded(e,t){this.obstacleGroup=e,this.previewObstacleGroup=t,this.obstacleGroup.clearAndDestroy(),this.usesPreviewObstacles&&this.previewObstacleGroup.clearAndDestroy(),await this.loadedPromise}notifyStrategyLoaded(){this.loadedResolver&&(this.loadedResolver(),this.loadedResolver=void 0)}finalizePreviewObstacle(e,t,s){t.length>0&&(e.setPoints(t),e.startFlashing(this.gameEngine.getTimer(),N(250)),this.previewObstacleGroup.add(e),e.on(I.DESTROYED,()=>{s.spawnGrid.removeSource(e)}))}}class ae extends z{usesPreviewObstacles=!1;currentObstacle=null;currentPosition=new l(0,0);reset(){super.reset(),this.currentObstacle=null,this.currentPosition=new l(0,0),this.notifyStrategyLoaded()}spawnNewObstacles(e,t){const s=[];if(this.currentObstacle===null){const i=this.findSafeInitialPosition(e.snakeGrid);this.currentPosition=i,this.currentObstacle=new P(this.currentPosition,!1,this.gameEngine.getTotalTicks(),[]);const r=this.generateObstaclePoints();this.currentObstacle.setPoints(r),this.obstacleGroup.add(this.currentObstacle);const o=this.addToGrids(e,this.currentObstacle,this.currentPosition);s.push(...o),this.setupObstacleCleanup(e,this.currentObstacle)}else{const i=this.calculateNextPosition();if(this.wouldCollideWithSnake(i,e.snakeGrid))return s;this.currentPosition=i,this.removeFromGrids(e,this.currentObstacle),this.currentObstacle.setPosition(this.currentPosition);const r=this.addToGrids(e,this.currentObstacle,this.currentPosition);s.push(...r)}return s}wouldCollideWithSnake(e,t){return(this.currentObstacle?this.currentObstacle.getPointsRef():this.generateObstaclePoints()).some(i=>{const r=new l(e.x+i.point.x,e.y+i.point.y);return t.containsPoint(r).length>0})}addToGrids(e,t,s){const i=[],r=t.getPointsRef();for(const o of r){const a=new l(s.x+o.point.x,s.y+o.point.y),h=e.collisionGrid.containsPoint(a);i.push(...h),e.collisionGrid.add(a,t),e.spawnGrid.add(a,t)}return i}removeFromGrids(e,t){e.collisionGrid.removeSource(t),e.spawnGrid.removeSource(t)}setupObstacleCleanup(e,t){t.on(I.DESTROYED,()=>{e.collisionGrid.removeSource(t),e.spawnGrid.removeSource(t),this.currentObstacle=null})}}class Pt extends z{name="Boundary Wall";levelName="Implosion";currentBounds=null;lastDirection=null;reset(){super.reset(),this.currentBounds=null,this.lastDirection=null,this.notifyStrategyLoaded()}spawnNewObstacles(e,t){const s=[];if(this.previewObstacleGroup.getAllActive().length===0||t){this.currentBounds===null&&(this.currentBounds={minX:0,maxX:d.ARENA_SIZE-1,minY:0,maxY:d.ARENA_SIZE-1});const r=this.currentBounds.maxX-this.currentBounds.minX+1,o=this.currentBounds.maxY-this.currentBounds.minY+1;if(r<=10||o<=10)return s;let h=[...["NORTH","SOUTH","EAST","WEST"]];this.lastDirection&&h.length>1&&(h=h.filter(g=>g!==this.lastDirection));const c=this.prng.randomChoice(h);let u=!1;switch(c){case"NORTH":{const g=this.currentBounds.minY+2;for(let f=this.currentBounds.minX;f<=this.currentBounds.maxX;f++)if(e.snakeGrid.containsPoint(new l(f,g)).length>0){u=!0;break}break}case"SOUTH":{const g=this.currentBounds.maxY-2;for(let f=this.currentBounds.minX;f<=this.currentBounds.maxX;f++)if(e.snakeGrid.containsPoint(new l(f,g)).length>0){u=!0;break}break}case"EAST":{const g=this.currentBounds.maxX-2;for(let f=this.currentBounds.minY;f<=this.currentBounds.maxY;f++)if(e.snakeGrid.containsPoint(new l(g,f)).length>0){u=!0;break}break}case"WEST":{const g=this.currentBounds.minX+2;for(let f=this.currentBounds.minY;f<=this.currentBounds.maxY;f++)if(e.snakeGrid.containsPoint(new l(g,f)).length>0){u=!0;break}break}}if(u)return s;const p=new P(new l(0,0),!0,this.gameEngine.getTotalTicks(),[]),m=[];switch(c){case"NORTH":for(let g=this.currentBounds.minX;g<=this.currentBounds.maxX;g++){const f=new l(g,this.currentBounds.minY);if(e.snakeGrid.containsPoint(f).length===0){const E=e.collisionGrid.containsPoint(f);s.push(...E),m.push({point:f}),e.spawnGrid.add(f,p)}}break;case"SOUTH":for(let g=this.currentBounds.minX;g<=this.currentBounds.maxX;g++){const f=new l(g,this.currentBounds.maxY);if(e.snakeGrid.containsPoint(f).length===0){const E=e.collisionGrid.containsPoint(f);s.push(...E),m.push({point:f}),e.spawnGrid.add(f,p)}}break;case"EAST":for(let g=this.currentBounds.minY;g<=this.currentBounds.maxY;g++){const f=new l(this.currentBounds.maxX,g);if(e.snakeGrid.containsPoint(f).length===0){const E=e.collisionGrid.containsPoint(f);s.push(...E),m.push({point:f}),e.spawnGrid.add(f,p)}}break;case"WEST":for(let g=this.currentBounds.minY;g<=this.currentBounds.maxY;g++){const f=new l(this.currentBounds.minX,g);if(e.snakeGrid.containsPoint(f).length===0){const E=e.collisionGrid.containsPoint(f);s.push(...E),m.push({point:f}),e.spawnGrid.add(f,p)}}break}if(this.finalizePreviewObstacle(p,m,e),m.length>0){switch(c){case"NORTH":this.currentBounds.minY++;break;case"SOUTH":this.currentBounds.maxY--;break;case"EAST":this.currentBounds.maxX--;break;case"WEST":this.currentBounds.minX++;break}this.lastDirection=c}}return s}}class Nt extends z{name="Four Block";levelName="Confetti";reset(){super.reset(),this.notifyStrategyLoaded()}spawnNewObstacles(e,t){const s=[];if(this.previewObstacleGroup.getAllActive().length===0||t){const r=new P(new l(0,0),!0,this.gameEngine.getTotalTicks(),[]),o=[],a=10;let h=0;for(;h<a;){const u=this.prng.randomBoolean(.5)?this.tryPlaceHorizontalLine(e):this.tryPlaceVerticalLine(e);if(u.success){for(const p of u.points){const m=e.collisionGrid.containsPoint(p);s.push(...m),o.push({point:p}),e.spawnGrid.add(p,r)}break}h++}this.finalizePreviewObstacle(r,o,e)}return s}tryPlaceHorizontalLine(e){const t=this.prng.randomInt(0,d.ARENA_SIZE-4),s=this.prng.randomInt(0,d.ARENA_SIZE-1);return this.validateAndGeneratePoints(e,i=>new l(t+i,s))}tryPlaceVerticalLine(e){const t=this.prng.randomInt(0,d.ARENA_SIZE-1),s=this.prng.randomInt(0,d.ARENA_SIZE-4);return this.validateAndGeneratePoints(e,i=>new l(t,s+i))}validateAndGeneratePoints(e,t){const s=[];for(let i=0;i<4;i++){const r=t(i);if(s.push(r),e.snakeGrid.containsPoint(r).length>0)return{success:!1,points:[]}}return{success:!0,points:s}}}class At extends z{name="Growing Square";levelName="Contagion";growthDirection="horizontal";growthCount=0;currentBounds=null;reset(){super.reset(),this.growthDirection="horizontal",this.growthCount=0,this.currentBounds=null,this.notifyStrategyLoaded()}spawnNewObstacles(e,t){const s=[];if(this.previewObstacleGroup.getAllActive().length===0||t){const r=new P(new l(0,0),!0,this.gameEngine.getTotalTicks(),[]),o=[];if(this.currentBounds===null){const a=Math.floor(d.ARENA_SIZE/2),h=Math.floor(d.ARENA_SIZE/2),c=new l(a,h);if(e.snakeGrid.containsPoint(c).length===0){const p=e.collisionGrid.containsPoint(c);s.push(...p);const m={point:c};o.push(m),e.spawnGrid.add(c,r),this.currentBounds={minX:a,maxX:a,minY:h,maxY:h},this.growthCount=0,this.growthDirection="horizontal"}}else{const{minX:a,maxX:h,minY:c,maxY:u}=this.currentBounds,p=[];this.growthDirection==="horizontal"?p.push("left","right"):p.push("top","bottom");for(const m of p)switch(m){case"top":for(let g=a;g<=h;g++){const f=c-1,E=new l(g,f);if(f>=0&&f<d.ARENA_SIZE&&e.snakeGrid.containsPoint(E).length===0){const R=e.collisionGrid.containsPoint(E);s.push(...R);const C={point:E};o.push(C),e.spawnGrid.add(E,r),this.currentBounds.minY=Math.min(this.currentBounds.minY,f)}}break;case"bottom":for(let g=a;g<=h;g++){const f=u+1,E=new l(g,f);if(f>=0&&f<d.ARENA_SIZE&&e.snakeGrid.containsPoint(E).length===0){const R=e.collisionGrid.containsPoint(E);s.push(...R);const C={point:E};o.push(C),e.spawnGrid.add(E,r),this.currentBounds.maxY=Math.max(this.currentBounds.maxY,f)}}break;case"left":for(let g=c;g<=u;g++){const f=a-1,E=new l(f,g);if(f>=0&&f<d.ARENA_SIZE&&e.snakeGrid.containsPoint(E).length===0){const R=e.collisionGrid.containsPoint(E);s.push(...R);const C={point:E};o.push(C),e.spawnGrid.add(E,r),this.currentBounds.minX=Math.min(this.currentBounds.minX,f)}}break;case"right":for(let g=c;g<=u;g++){const f=h+1,E=new l(f,g);if(f>=0&&f<d.ARENA_SIZE&&e.snakeGrid.containsPoint(E).length===0){const R=e.collisionGrid.containsPoint(E);s.push(...R);const C={point:E};o.push(C),e.spawnGrid.add(E,r),this.currentBounds.maxX=Math.max(this.currentBounds.maxX,f)}}break}this.growthCount++,this.growthCount>=2&&(this.growthDirection=this.growthDirection==="horizontal"?"vertical":"horizontal",this.growthCount=0)}this.finalizePreviewObstacle(r,o,e)}return s}}class _t extends ae{name="Vertical Moving Wall";levelName="Paint the Fence";generateObstaclePoints(){const e=[];for(let t=0;t<4;t++)for(let s=0;s<d.ARENA_SIZE;s++)e.push({point:new l(t,s)});return e}findSafeInitialPosition(e){for(let s=0;s<50;s++){const i=this.prng.randomInt(0,d.ARENA_SIZE-4),r=new l(i,0);if(!this.wouldCollideWithSnake(r,e))return r}const t=this.prng.randomInt(0,d.ARENA_SIZE-4);return new l(t,0)}calculateNextPosition(){let e=this.currentPosition.x-4;return e<0&&(e=d.ARENA_SIZE-4),new l(e,0)}getThickness(){return 4}}class bt extends ae{name="Horizontal Moving Wall";levelName="Wax On";generateObstaclePoints(){const e=[];for(let t=0;t<4;t++)for(let s=0;s<d.ARENA_SIZE;s++)e.push({point:new l(s,t)});return e}findSafeInitialPosition(e){for(let s=0;s<50;s++){const i=this.prng.randomInt(0,d.ARENA_SIZE-4),r=new l(0,i);if(!this.wouldCollideWithSnake(r,e))return r}const t=this.prng.randomInt(0,d.ARENA_SIZE-4);return new l(0,t)}calculateNextPosition(){let e=this.currentPosition.y-4;return e<0&&(e=d.ARENA_SIZE-4),new l(0,e)}getThickness(){return 4}}class Ot extends ae{name="Moving Cross";levelName="Gauntlet";generateObstaclePoints(){const e=[],s=d.ARENA_SIZE*2;for(let i=-4;i<4;i++)for(let r=-s/2;r<s/2;r++)e.push({point:new l(r,i)});for(let i=-4;i<4;i++)for(let r=-s/2;r<s/2;r++)r>=-4&&r<4||e.push({point:new l(i,r)});return e}findSafeInitialPosition(e){const t=Math.floor(d.ARENA_SIZE/2),s=Math.floor(d.ARENA_SIZE/2),i=new l(t,s);if(!this.wouldCollideWithSnake(i,e))return i;const r=8;for(let o=4;o<d.ARENA_SIZE-4;o+=r)for(let a=4;a<d.ARENA_SIZE-4;a+=r){const h=new l(a,o);if(!this.wouldCollideWithSnake(h,e))return h}for(let o=0;o<50;o++){const a=new l(this.prng.randomInt(4,d.ARENA_SIZE-5),this.prng.randomInt(4,d.ARENA_SIZE-5));if(!this.wouldCollideWithSnake(a,e))return a}return i}calculateNextPosition(){let e=(this.currentPosition.x+6)%d.ARENA_SIZE,t=(this.currentPosition.y+6)%d.ARENA_SIZE;return new l(e,t)}getThickness(){return 8}}class Rt extends z{name="Blank Map";levelName="???";constructor(e){super(e),this.notifyStrategyLoaded()}spawnNewObstacles(e,t){return[]}}class _e extends z{name="Static Map";levelName;_isStatic=!0;mapData=null;level;mapName;cachedObstacles=[];reservedSpawnPoints=[];constructor(e,t,s,i="Static Level"){super(e),this.level=t,this.levelName=i,this.mapName=s,this.mapData=null,this.cachedObstacles=[],this.reservedSpawnPoints=[]}async loadMapWithRetry(e=10,t=100){for(let s=1;s<=e;s++)try{const i=await this.gameEngine.getLoader().fetchData(`${this.mapName}.json`,{requiredForValidation:!0});this.mapData=JSON.parse(i),this.precalculateObstacles(),this.notifyStrategyLoaded();return}catch(i){if(console.error(`Static Map: Error loading map "${this.mapName}" for level ${this.level} (attempt ${s}/${e}):`,i),s<e)await new Promise(r=>setTimeout(r,t));else throw console.error(`Static Map: Failed to load map "${this.mapName}" after ${e} attempts`),i}}precalculateObstacles(){if(!this.mapData)return;this.cachedObstacles=[],this.reservedSpawnPoints=[];const e=50;for(let t=0;t<e;t++){const s=this.mapData[t];if(s)for(let i=0;i<e;i++){const r=s[i];r>=1?this.cachedObstacles.push({point:new l(i,t)}):r===-1&&this.reservedSpawnPoints.push(new l(i,t))}}this.gameEngine.setReservedSpawnPositions(this.reservedSpawnPoints)}reset(){super.reset(),this.loadMapWithRetry().catch(e=>{console.error("Static Map: Failed to load map in reset:",e)}),this.cachedObstacles=[],this.gameEngine.setReservedSpawnPositions([])}spawnNewObstacles(e,t){const s=[];if(this.obstacleGroup.activeSize()>0)return s;if(!this.mapData||this.cachedObstacles.length===0)return this.loadMapWithRetry().catch(i=>{console.error("Static Map: Failed to load map in spawnNewObstacles:",i)}),s;if(this.cachedObstacles.length>0){const i=new P(new l(0,0),!1,this.gameEngine.getTotalTicks(),[...this.cachedObstacles]);this.obstacleGroup.add(i),i.getPointsRef().forEach(r=>{const o=e.collisionGrid.containsPoint(r.point);s.push(...o),e.collisionGrid.add(r.point,i),e.spawnGrid.add(r.point,i)}),i.on(I.DESTROYED,()=>{e.collisionGrid.removeSource(i),e.spawnGrid.removeSource(i)})}return s}}class Ct{gameEngine;prng;strategyCache=new Map;lastUsedStrategyIndex=null;usedStrategiesForLevels2Plus=new Set;constructor(e){this.gameEngine=e,this.prng=e.getPrng(),this.strategyCache=new Map,this.getCachedStrategy("growing-square",()=>new At(e)),this.getCachedStrategy("boundary-wall",()=>new Pt(e)),this.getCachedStrategy("four-block",()=>new Nt(e)),this.getCachedStrategy("moving-cross",()=>new Ot(e)),this.getCachedStrategy("horizontal-moving-wall",()=>new bt(e)),this.getCachedStrategy("vertical-moving-wall",()=>new _t(e))}getCachedStrategy(e,t){return this.strategyCache.has(e)||this.strategyCache.set(e,t()),this.strategyCache.get(e)}getStrategyForLevel(e,t){if(e===1){if(!t)throw new Error("mapName is required for level 1");return new _e(this.gameEngine,e,t,"Level 1")}const s=[{key:"growing-square",name:"Contagion"},{key:"boundary-wall",name:"Implosion"},{key:"four-block",name:"Confetti"},{key:"moving-cross",name:"Gauntlet"},{key:"horizontal-moving-wall",name:"Wax On"},{key:"vertical-moving-wall",name:"Paint the Fence"}];this.usedStrategiesForLevels2Plus.size>=s.length&&this.usedStrategiesForLevels2Plus.clear();const i=s.filter(o=>!this.usedStrategiesForLevels2Plus.has(o.key)),r=this.prng.randomChoice(i);return this.usedStrategiesForLevels2Plus.add(r.key),this.getCachedStrategy(r.key)}clearCache(){this.strategyCache.clear(),this.usedStrategiesForLevels2Plus.clear()}getRandomStrategy(){const e=Array.from(this.strategyCache.values()),t=this.prng.randomInt(0,e.length-1);if(e.length>1&&this.lastUsedStrategyIndex!==null&&t===this.lastUsedStrategyIndex){const s=(t+1)%e.length;return this.lastUsedStrategyIndex=s,e[s]}return this.lastUsedStrategyIndex=t,e[t]}getStrategyByKey(e){if(this.strategyCache.has(e))return this.strategyCache.get(e)||null;if(e.includes("_")){const t=new _e(this.gameEngine,1,e);return this.strategyCache.set(e,t),t}return null}}const be=N(1e4),xt=N(2e3);class b extends W{static TypeName="Consumable";static idCounter=0;spawnTick;hidden;lastToggleTick;constructor(e,t,s){const i=s||`consumable_${++b.idCounter}`;super(i,e,new l(1,1),1),this.spawnTick=t,this.hidden=!1,this.lastToggleTick=t}getType(){return b.TypeName}isHidden(){return this.hidden}setHidden(e){this.hidden!==e&&(this.hidden=e,this.needsRepaint=!0)}update(e,t){if(super.update(e,t),this.destroyed)return;const s=t-this.spawnTick;s>=be-xt&&t-this.lastToggleTick>=Ce/5&&(this.hidden=!this.hidden,this.lastToggleTick=t,this.needsRepaint=!0),s>=be&&this.destroy()}serialize(){return{position:{x:this.position.x,y:this.position.y},size:{x:this.size.x,y:this.size.y},velocity:{x:this.velocity.x,y:this.velocity.y},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,isDestroyed:this.destroyed,spawnTick:this.spawnTick,hidden:this.hidden,lastToggleTick:this.lastToggleTick}}static deserialize(e){const t=new b(new l(e.position.x,e.position.y),e.spawnTick);return t.setVelocity(new l(e.velocity.x,e.velocity.y)),t.setRotation(e.rotation),t.health=e.health,t.maxHealth=e.maxHealth,t.destroyed=e.isDestroyed,t.hidden=e.hidden,t.lastToggleTick=e.lastToggleTick,t}}J.registerType(b.TypeName,b);class O extends W{static TypeName="PowerUp";static idCounter=0;powerUpType;spawnTick;isHelpful;constructor(e,t,s=!0,i,r){const o=r||`powerup_${++O.idCounter}`;super(o,e,new l(1,1),1),this.powerUpType=t,this.spawnTick=i,this.isHelpful=s}getType(){return O.TypeName}getPowerUpType(){return this.powerUpType}isHelpfulPowerUp(){return this.isHelpful}getPotionType(){return this.isHelpful?"helpful":"hindering"}containsPoint(e){const t=this.getPosition();return t.x===e.x&&t.y===e.y}update(e,t){if(super.update(e,t),this.destroyed)return;t-this.spawnTick>=d.POWER_UP_DURATION&&this.destroy()}serialize(){return{position:{x:this.position.x,y:this.position.y},size:{x:this.size.x,y:this.size.y},velocity:{x:this.velocity.x,y:this.velocity.y},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,isDestroyed:this.destroyed,powerUpType:this.powerUpType,spawnTick:this.spawnTick,isHelpful:this.isHelpful}}static deserialize(e){const t=new O(new l(e.position.x,e.position.y),e.powerUpType,e.isHelpful,e.spawnTick);return t.setVelocity(new l(e.velocity.x,e.velocity.y)),t.setRotation(e.rotation),t.health=e.health,t.maxHealth=e.maxHealth,t.destroyed=e.isDestroyed,t}}J.registerType(O.TypeName,O);class D extends W{static TypeName="Snake";static idCounter=0;bodyPositions;direction;snakeLength;dontRemoveTailInNextMoveIteration=!1;constructor(e,t=y.RIGHT,s){const i=s||`snake_${++D.idCounter}`;super(i,e[0]||new l(0,0),new l(1,1),e.length),this.direction=t,this.snakeLength=e.length,this.bodyPositions=[...e]}getType(){return D.TypeName}getDirection(){return this.direction}setDirection(e){this.direction=e,this.needsRepaint=!0}getLength(){return this.snakeLength}getPositions(){return[...this.bodyPositions]}getHeadPosition(){return this.bodyPositions.length>0?this.bodyPositions[0]:null}getTailPosition(){return this.bodyPositions.length>0?this.bodyPositions[this.bodyPositions.length-1]:null}getSegmentType(e){return e<0||e>=this.bodyPositions.length?"body":e===0?"head":e===this.bodyPositions.length-1?"tail":"body"}move(e){if(this.bodyPositions.unshift(e),this.emit("segmentAdded",this,e),this.setPosition(e),this.dontRemoveTailInNextMoveIteration)this.snakeLength++,this.dontRemoveTailInNextMoveIteration=!1;else{const t=this.bodyPositions.pop();t&&this.emit("segmentRemoved",this,t)}this.needsRepaint=!0}grow(){this.dontRemoveTailInNextMoveIteration=!0,this.needsRepaint=!0}update(e,t){if(super.update(e,t),this.destroyed)return;const s=this.getHeadPosition();s&&this.setPosition(s)}serialize(){return{position:{x:this.position.x,y:this.position.y},size:{x:this.size.x,y:this.size.y},velocity:{x:this.velocity.x,y:this.velocity.y},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,isDestroyed:this.destroyed,bodyPositions:this.bodyPositions.map(e=>({x:e.x,y:e.y})),direction:this.direction,snakeLength:this.snakeLength}}static deserialize(e){const t=e.bodyPositions.map(i=>new l(i.x,i.y)),s=new D(t,e.direction,void 0);return s.setVelocity(new l(e.velocity.x,e.velocity.y)),s.setRotation(e.rotation),s.health=e.health,s.maxHealth=e.maxHealth,s.destroyed=e.isDestroyed,s}}J.registerType(D.TypeName,D);const Oe="preview_obstacle";var Le=(n=>(n.LEVEL_CHANGE="levelChange",n))(Le||{});class kt extends ut{gameSnapshot={};currentMoveInterval=d.INITIAL_MOVE_INTERVAL;directionQueue=[];speedIncreaseCount=0;reservedSpawnPositions=new Set;applesEaten=0;potionsEaten=0;currentObstacleStrategy={};strategyManager={};isLoadingLevel=!1;collisionBspTree;spawnBspTree;snakeBspTree;constructor(e){super(e),this.collisionBspTree=new Q,this.spawnBspTree=new Q,this.snakeBspTree=new Q,this.reservedSpawnPositions.clear(),this.setupInputHandling()}async reset(e){this.platform.audio.stopAll(),await super.reset(e)}end(){super.end(),this.platform.audio.stopAll()}handleGameObjectDestroyed=e=>{e.off(I.POSITION_CHANGED,this.handleGameObjectPositionChanged),this.collisionBspTree.removeSource(e),this.spawnBspTree.removeSource(e)};getSnake(){const e=this.gameObjectGroups.get(D.TypeName);return e?e.getById("snake-1"):null}getObstacles(){let e=this.gameObjectGroups.get(P.TypeName);return e||(e=new F,this.gameObjectGroups.set(P.TypeName,e)),e}getPreviewObstacles(){let e=this.gameObjectGroups.get(Oe);return e||(e=new F,this.gameObjectGroups.set(Oe,e)),e}getConsumables(){let e=this.gameObjectGroups.get(b.TypeName);return e||(e=new F,this.gameObjectGroups.set(b.TypeName,e)),e}getPowerUps(){let e=this.gameObjectGroups.get(O.TypeName);return e||(e=new F,this.gameObjectGroups.set(O.TypeName,e)),e}getActiveEffects(){return this.gameSnapshot.activeEffects}isGameRunning(){return this.state===S.PLAYING}isGameOver(){return this.state===S.ENDED}isGamePaused(){return this.state===S.PAUSED}getLoader(){return super.getLoader()}getPrng(){return this.prng}getGameSnapshot(){return{...this.gameSnapshot,state:this.state,levelName:this.currentObstacleStrategy.levelName,applesEaten:this.applesEaten,potionsEaten:this.potionsEaten}}start(){this.platform.audio.tryResumeOnce(),this.setupTimers(),this.spawnConsumable(),super.start()}setReservedSpawnPositions(e){this.reservedSpawnPositions=new Set(e.map(t=>this.serializePosition(t)))}serializePosition(e){return`${e.x},${e.y}`}isReservedSpawnPosition(e){return this.reservedSpawnPositions.has(this.serializePosition(e))}setupTimers(){this.timer.reset(),this.setInterval(()=>{this.clearDestroyedGameObjects()},600);const e=()=>{this.moveSnake(),this.setTimeout(e,this.currentMoveInterval)};this.setTimeout(e,this.currentMoveInterval),this.setInterval(()=>{this.speedIncreaseCount++,this.currentMoveInterval=Math.max(this.currentMoveInterval-d.SPEED_INCREASE_AMOUNT,d.MIN_MOVE_INTERVAL)},d.SPEED_INCREASE_INTERVAL),this.setInterval(()=>{this.getPowerUps().activeSize()===0&&this.prng.randomBoolean(d.POWER_UP_SPAWN_CHANCE)&&this.spawnPowerUp()},d.POWER_UP_SPAWN_INTERVAL),this.setInterval(()=>{this.getConsumables().activeSize()===0&&this.spawnConsumable()},d.CONSUMABLE_SPAWN_INTERVAL),this.setInterval(()=>{this.spawnNextObstacles()},d.OBSTACLE_SPAWN_INTERVAL)}changeDirection(e){const s=this.getEventManager().getSource();s instanceof xe?s.queueInput("direction",{direction:e}):this.changeDirectionInternal(e)}changeDirectionInternal(e){const t=this.getSnake();if(!t)return;this.gameSnapshot.activeEffects.some(o=>o.type===w.INVERTED_CONTROLS)&&(e={[y.UP]:y.DOWN,[y.DOWN]:y.UP,[y.LEFT]:y.RIGHT,[y.RIGHT]:y.LEFT}[e]);const i=t.getDirection(),r={[y.UP]:y.DOWN,[y.DOWN]:y.UP,[y.LEFT]:y.RIGHT,[y.RIGHT]:y.LEFT};if(r[i]!==e){const o=this.directionQueue.length>0?this.directionQueue[this.directionQueue.length-1]:i;r[o]!==e&&(this.directionQueue.length===0||this.directionQueue[this.directionQueue.length-1]!==e)&&this.directionQueue.push(e)}}async setup(e){St(this.platform.audio),this.collisionBspTree.clear(),this.spawnBspTree.clear(),this.snakeBspTree.clear(),this.strategyManager=new Ct(this);const t=e.gameSpecific?.initialMapName;this.currentObstacleStrategy=this.strategyManager.getStrategyForLevel(1,t),this.gameSnapshot={state:S.READY,activeEffects:[],score:0,level:1,levelName:this.currentObstacleStrategy.levelName,applesEaten:0,potionsEaten:0},this.currentMoveInterval=d.INITIAL_MOVE_INTERVAL,this.directionQueue=[],this.speedIncreaseCount=0,this.applesEaten=0,this.potionsEaten=0,this.setReservedSpawnPositions([]),this.isLoadingLevel=!1,await this.loadStrategyAndSetupMap(),this.createSnake()}setupInputHandling(){this.getEventManager().onUserInput=e=>{if(e.inputType===ie.INTENT&&e.params?.intent){const t=this.getSnake()?.getDirection();switch(e.params.intent){case A.UP:this.changeDirectionInternal(y.UP);break;case A.DOWN:this.changeDirectionInternal(y.DOWN);break;case A.LEFT:this.changeDirectionInternal(y.LEFT);break;case A.RIGHT:this.changeDirectionInternal(y.RIGHT);break;case A.CLOCKWISE:{if(!t)break;const s=(()=>{switch(t){case y.UP:return y.RIGHT;case y.RIGHT:return y.DOWN;case y.DOWN:return y.LEFT;case y.LEFT:return y.UP}})();this.changeDirectionInternal(s);break}case A.COUNTER_CLOCKWISE:{if(!t)break;const s=(()=>{switch(t){case y.UP:return y.LEFT;case y.LEFT:return y.DOWN;case y.DOWN:return y.RIGHT;case y.RIGHT:return y.UP}})();this.changeDirectionInternal(s);break}}}}}update(e){super.update(e),this.state===S.PLAYING&&this.checkCollisions()}moveSnake(){const e=this.getSnake();if(!e)return;if(this.directionQueue.length>0){const i=this.directionQueue.shift();e.setDirection(i)}const t=e.getHeadPosition(),s=this.getNextPosition(t,e.getDirection());e.move(s)}getNextPosition(e,t){const{ARENA_SIZE:s}=d;let{x:i,y:r}=e;switch(t){case y.UP:r=r===0?s-1:r-1;break;case y.DOWN:r=r===s-1?0:r+1;break;case y.LEFT:i=i===0?s-1:i-1;break;case y.RIGHT:i=i===s-1?0:i+1;break}return new l(i,r)}checkCollisions(){const e=this.getSnake();if(!e)return;const s=e.getPositions()[0],i=s.x<0||s.x>=d.ARENA_SIZE||s.y<0||s.y>=d.ARENA_SIZE,r=this.collisionBspTree.containsPoint(s),o=r.length>0;for(const a of r){const h=a;if(!h.isDestroyed())switch(h.getType()){case b.TypeName:{h.destroy();const c=1+this.speedIncreaseCount;this.gameSnapshot.score+=c,this.applesEaten++,e.grow(),this.platform.audio.playSound(_.EAT);const u=this.gameSnapshot.level-1,p=Tt[u];p&&e.getLength()>=p.maxSnakeLength||this.spawnConsumable(),this.applesEaten%d.APPLES_TO_LEVEL_UP===0&&this.goToNextLevel();break}case O.TypeName:{const c=h;h.destroy(),this.gameSnapshot.score+=5,this.gameSnapshot.potionsEaten+=1,this.potionsEaten+=1,this.applyPowerUpEffect(c);break}case P.TypeName:{const c=this.gameSnapshot.activeEffects.some(u=>u.type===w.INVINCIBLE);(i||o)&&!c&&this.end()}}}}async loadStrategyAndSetupMap(){const e=this.getObstacles(),t=this.getPreviewObstacles(),s=this.getConsumables();e.clearAndDestroy(),t.clearAndDestroy(),s.clearAndDestroy(),this.currentObstacleStrategy.reset(),await this.currentObstacleStrategy.setOnStrategyLoaded(e,t),this.spawnObstacles(),this.spawnConsumable()}spawnConsumable(){if(this.isLoadingLevel||this.getConsumables().activeSize()>0)return null;const t=this.findAvailableSpawnPoint();if(t===null)return null;const s=new b(t,this.totalTicks);return this.registerGameObject(s),this.collisionBspTree.add(t,s),this.spawnBspTree.add(t,s),s.on(I.POSITION_CHANGED,this.handleGameObjectPositionChanged),s.on(I.DESTROYED,this.handleGameObjectDestroyed),s}hasTooManyAdjacentObstacles(e){const t=[new l(e.x-1,e.y),new l(e.x+1,e.y),new l(e.x,e.y-1),new l(e.x,e.y+1)];let s=0;for(const i of t){if(i.x<0||i.x>=d.ARENA_SIZE||i.y<0||i.y>=d.ARENA_SIZE){s++;continue}this.collisionBspTree.containsPoint(i).some(o=>o instanceof P)&&s++}return s>=3}spawnPowerUp(){const e=this.findAvailableSpawnPoint();if(e===null)return;let t,s;this.prng.randomBoolean(.65)?(t=this.prng.randomChoice([w.INVINCIBLE,w.SLOW_DOWN]),s=!0):(t=this.prng.randomChoice([w.INVERTED_CONTROLS,w.DARKNESS]),s=!1);const r=new O(e,t,s,this.totalTicks);this.registerGameObject(r),this.collisionBspTree.add(e,r),this.spawnBspTree.add(e,r),r.on(I.POSITION_CHANGED,this.handleGameObjectPositionChanged),r.on(I.DESTROYED,this.handleGameObjectDestroyed)}applyPowerUpEffect(e){const t=Date.now();this.platform.audio.stopSound(_.INVINCIBLE),this.platform.audio.stopSound(_.INVERTED);const s=this.gameSnapshot.activeEffects.some(o=>o.type===w.SLOW_DOWN);this.gameSnapshot.activeEffects=[],s&&this.resetSpeedToNormal();const i=e.getPowerUpType()===w.SLOW_DOWN?d.SLOW_DOWN_EFFECT_DURATION:d.POWER_UP_EFFECT_DURATION,r={type:e.getPowerUpType(),startTime:t,duration:i,isHelpful:e.isHelpfulPowerUp(),timerId:0};r.timerId=this.setTimeout(()=>{r.type===w.INVINCIBLE?this.platform.audio.stopSound(_.INVINCIBLE):r.type===w.INVERTED_CONTROLS?this.platform.audio.stopSound(_.INVERTED):r.type===w.SLOW_DOWN?this.resetSpeedToNormal():r.type===w.DARKNESS&&this.platform.audio.stopSound(_.INVERTED),this.gameSnapshot.activeEffects=this.gameSnapshot.activeEffects.filter(o=>o!==r)},i),this.gameSnapshot.activeEffects=[...this.gameSnapshot.activeEffects,r],e.getPowerUpType()===w.INVINCIBLE?this.platform.audio.playSound(_.INVINCIBLE,1,!0):e.getPowerUpType()===w.INVERTED_CONTROLS?this.platform.audio.playSound(_.INVERTED,1,!0):e.getPowerUpType()===w.SLOW_DOWN?(this.platform.audio.playSound(_.SLOW_DOWN),this.currentMoveInterval=d.INITIAL_MOVE_INTERVAL):e.getPowerUpType()===w.DARKNESS&&this.platform.audio.playSound(_.INVERTED,1,!0)}spawnNextObstacles(){if(!this.currentObstacleStrategy.isStatic())try{this.spawnObstacles()}catch(e){console.error("Error spawning obstacles:",e)}}spawnObstacles(){if(!this.getObstacles()){console.error("Invalid game state for obstacle spawning");return}const t={collisionGrid:this.collisionBspTree,spawnGrid:this.spawnBspTree,snakeGrid:this.snakeBspTree},s=this.currentObstacleStrategy.spawnObstacles(t);for(const i of s.collidesWith)if(i instanceof W)switch(i.destroy(),i.getType()){case b.TypeName:this.spawnConsumable();break;case O.TypeName:this.spawnPowerUp();break}}resetSpeedToNormal(){const e=Math.max(d.INITIAL_MOVE_INTERVAL-this.speedIncreaseCount*d.SPEED_INCREASE_AMOUNT,d.MIN_MOVE_INTERVAL);this.currentMoveInterval=e}goToNextLevel(){this.pause(),this.emit("levelChange"),this.platform.audio.playSound(_.ARENA_RESET),this.gameSnapshot.level++,this.resetArenaObstaclesAndBounds(),this.currentMoveInterval=Math.min(this.currentMoveInterval+N(20),d.INITIAL_MOVE_INTERVAL);const e=this.gameSnapshot.level;this.currentObstacleStrategy=this.strategyManager.getStrategyForLevel(e),this.gameSnapshot.levelName=this.currentObstacleStrategy.levelName,this.currentObstacleStrategy.reset(),this.currentObstacleStrategy.setOnStrategyLoaded(this.getObstacles(),this.getPreviewObstacles()).then(()=>{this.spawnObstacles(),this.resume()})}findSafeSnakeSpawnPosition(){let t=0;for(;t<50;){const s=this.prng.randomInt(1,d.ARENA_SIZE-d.INITIAL_SNAKE_LENGTH-1),i=this.prng.randomInt(1,d.ARENA_SIZE-2),r=new l(s,i);if(Array.from({length:d.INITIAL_SNAKE_LENGTH},(h,c)=>new l(r.x+c,r.y)).every(h=>this.collisionBspTree.containsPoint(h).length===0))return r;t++}return $}createSnake(){let e=$;if(Array.from({length:d.INITIAL_SNAKE_LENGTH},(h,c)=>new l($.x+c,$.y)).some(h=>this.collisionBspTree.containsPoint(h).length>0)){const h=this.findSafeSnakeSpawnPosition();h&&(e=h)}const i=Array.from({length:d.INITIAL_SNAKE_LENGTH},(h,c)=>new l(e.x+c,e.y)).reverse(),r=new D(i,It,"snake-1");this.gameObjectGroups.get(D.TypeName)?.clear(),this.registerGameObject(r);const o=this.getSnake();if(!o)throw new Error("Failed to create snake");o.getPositions().forEach(h=>{this.collisionBspTree.add(h,o),this.spawnBspTree.add(h,o),this.snakeBspTree.add(h,o)}),o.on("segmentAdded",this.handleSnakeSegmentAdded),o.on("segmentRemoved",this.handleSnakeSegmentRemoved)}handleSnakeSegmentAdded=(e,t)=>{this.collisionBspTree.containsPoint(t).find(i=>i===e)?this.end():(this.collisionBspTree.add(t,e),this.spawnBspTree.add(t,e),this.snakeBspTree.add(t,e))};handleSnakeSegmentRemoved=(e,t)=>{this.collisionBspTree.remove(t,e),this.spawnBspTree.remove(t,e),this.snakeBspTree.remove(t,e)};handleGameObjectPositionChanged=(e,t,s)=>{this.collisionBspTree.remove(t,e),this.collisionBspTree.add(s,e),this.spawnBspTree.remove(t,e),this.spawnBspTree.add(s,e)};findAvailableSpawnPoint(e=!0){let s=0,i;do{let r,o;r=this.prng.randomInt(0,d.ARENA_SIZE-1),o=this.prng.randomInt(0,d.ARENA_SIZE-1),i=new l(r,o),s++}while(s<10&&(this.spawnBspTree.containsPoint(i).length>0||this.isReservedSpawnPosition(i)||e&&this.hasTooManyAdjacentObstacles(i)));return s>=10?null:i}showPlaceholderMap(){this.resetArenaObstaclesAndBounds(),this.currentObstacleStrategy=new Rt(this),this.gameSnapshot.levelName="???"}resetArenaObstaclesAndBounds(){const e=this.getObstacles(),t=this.getPreviewObstacles();e.clearAndDestroy(),t.clearAndDestroy()}}class Mt extends oe{constructor(e){super(e)}getId(e){const t=e.getPosition();return`consumable_${t.x}_${t.y}_${e.getId()}`}create(e){const t=e.getPosition(),s=d.BLOCK_SIZE,i=s/2,r=s/2,o=s/2,a=this.createStandardNode(t.x*d.BLOCK_SIZE,t.y*d.BLOCK_SIZE,void 0,this.createCircle(i,L.CONSUMABLE,r,o));return a.drawCircle(r,o,i,void 0,0,1),a}repaintNode(e,t){const s=t.getPosition();e.setPosition(s.x*d.BLOCK_SIZE,s.y*d.BLOCK_SIZE),e.setVisible(!t.isHidden())}}class Dt{gridNode;gridDrawn=!1;constructor(e){this.gridNode=e}renderGrid(){if(this.gridDrawn)return;const e=d.ARENA_SIZE*d.BLOCK_SIZE;this.gridNode.drawRectangle(0,0,e,e,void 0,L.GRID,2),this.gridDrawn=!0}show(){this.gridNode.setVisible(!0)}hide(){this.gridNode.setVisible(!1)}destroy(){this.gridNode.clearGraphics(),this.gridDrawn=!1}}class he extends oe{activeEffects=[];needsEffectsRepaint=!1;constructor(e){super(e)}updateNode(e,t){t.needsRepaint?(this.applyUpdatedNode(e,t),t.needsRepaint=!1):this.needsEffectsRepaint&&this.applyUpdatedEffects(e,t)}setItems(e,t=[]){this.activeEffects!==t&&(this.needsEffectsRepaint=!0,this.activeEffects=t),super.setItems(e),this.needsEffectsRepaint=!1}}class Lt extends he{customObstacleColor;constructor(e,t){super(e),this.customObstacleColor=t}getId(e){return e.getId()}setObstacleColor(e){this.customObstacleColor=e}create(e){const t=e.getPosition(),s=d.BLOCK_SIZE,i=this.createStandardNode(t.x*s,t.y*s,void 0,this.createRectangle(1,1,0));return this.drawObstaclePoints(i,e),i.setTint(this.getObstacleColor()),i}applyUpdatedNode(e,t){const s=t.getPosition();e.setPosition(s.x*d.BLOCK_SIZE,s.y*d.BLOCK_SIZE),t.pointsNeedRepaint&&(e.clearGraphics(),this.drawObstaclePoints(e,t),t.pointsNeedRepaint=!1),e.setTint(this.getObstacleColor())}applyUpdatedEffects(e,t){e.setTint(this.getObstacleColor())}drawObstaclePoints(e,t){const s=d.BLOCK_SIZE,i=t.getPoints();for(const r of i){const o=r.point.x*s,a=r.point.y*s;e.drawRectangle(o,a,s,s,16777215,0,1)}}getObstacleColor(){return this.activeEffects.find(t=>t.type===w.DARKNESS)?657930:this.customObstacleColor?De(this.customObstacleColor):L.OBSTACLE}}class Gt extends oe{constructor(e){super(e)}getId(e){return`${e.getId()}_render`}create(e){const t=e.getPosition(),s=d.BLOCK_SIZE,i=this.createStandardNode(t.x*d.BLOCK_SIZE,t.y*d.BLOCK_SIZE,void 0,this.createRectangle(1,1,0)),r=s*1.6,o=s*1.8,a=s/2,h=s/2,c=r*.8,u=o*.7,p=a-c/2,m=h-u/2+o*.1;i.drawRoundRect(p,m,c,u,4,L.POWER_UP,0,2);const g=c*.4,f=o*.2,E=a-g/2,R=m-f;i.drawRoundRect(E,R,g,f,2,L.POWER_UP,0,2);const C=g*1.2,ce=o*.15,Be=a-C/2,He=R-ce;i.drawRoundRect(Be,He,C,ce,3,9127187,0,1);const le=c*.6,Ue=u*.5,We=a-le/2,ze=m+u*.2;return i.drawRoundRect(We,ze,le,Ue,2,16766720,0,1),i}repaintNode(e,t){const s=t.getPosition();e.setPosition(s.x*d.BLOCK_SIZE,s.y*d.BLOCK_SIZE)}}class Bt extends he{constructor(e){super(e)}getId(e){const t=e.getSpawnTick()||Date.now();return`preview_${e.getId()}_${t}`}create(e){const t=e.getPosition(),s=d.BLOCK_SIZE,i=this.createStandardNode(t.x*s,t.y*s,void 0,this.createRectangle(1,1,0));return this.drawPreviewPoints(i,e),i}applyUpdatedNode(e,t){const s=t.getPosition();e.setPosition(s.x*d.BLOCK_SIZE,s.y*d.BLOCK_SIZE),e.clearGraphics(),this.drawPreviewPoints(e,t)}applyUpdatedEffects(e,t){e.clearGraphics(),this.drawPreviewPoints(e,t)}drawPreviewPoints(e,t){const s=t.getPoints(),i=d.BLOCK_SIZE,r=t.isFlashingActive(),o=r?16777215:this.getPreviewObstacleColor(),a=r?16777215:0;for(const h of s){const c=h.point.x*i,u=h.point.y*i;e.drawRectangle(c,u,i,i,o,a,1)}}getPreviewObstacleColor(){return this.activeEffects.find(t=>t.type===w.DARKNESS)?657930:11206570}}const ee={HEAD:16777215,BODY:13421772,TAIL:10066329},Re=16776960,Ht=13412864;class Ut extends he{customSnakeColor;constructor(e,t){super(e),this.customSnakeColor=t}getId(e){return e.getId()}setSnakeColor(e){this.customSnakeColor=e}create(e){const t=this.createStandardNode(0,0,void 0,this.createRectangle(1,1,0));return this.drawSnakeSegments(t,e),t.setTint(this.getEffectColor()),t}applyUpdatedNode(e,t){e.clearGraphics(),this.drawSnakeSegments(e,t),e.setTint(this.getEffectColor())}applyUpdatedEffects(e,t){e.setTint(this.getEffectColor())}drawSnakeSegments(e,t){const s=t.getPositions(),i=d.BLOCK_SIZE;s.forEach((r,o)=>{let a;o===0?a=ee.HEAD:o===s.length-1?a=ee.TAIL:a=ee.BODY;const h=r.x*i,c=r.y*i;e.drawRectangle(h,c,i,i,a,0,1)})}getEffectColor(){const e=Date.now(),t=3e3,s=200,i=this.activeEffects.find(c=>c.type===w.INVINCIBLE&&c.isHelpful),r=this.activeEffects.find(c=>c.type===w.INVERTED_CONTROLS&&!c.isHelpful),o=this.activeEffects.find(c=>c.type===w.SLOW_DOWN&&c.isHelpful);let a,h=!1;if(i){const c=i.duration-(e-i.startTime),u=Math.floor(e/s)%2===0;return c<=t&&c>0?a=u?Re:this.getBaseColor():a=u?Re:Ht,a}else if(r){const c=r.duration-(e-r.startTime);c<=t&&c>0&&(h=!0),a=L.SNAKE_INVERTED}else if(o){const c=o.duration-(e-o.startTime);c<=t&&c>0&&(h=!0),a=L.SNAKE_SLOW}else a=this.getBaseColor();return h&&Math.floor(e/s)%2===0&&(a=this.getBaseColor()),a}getBaseColor(){return this.customSnakeColor?De(this.customSnakeColor):L.SNAKE}}class Wt extends ke{showSpinOverlay=!1;events={canvasClick:()=>{},directionChange:()=>{}};gridRenderer;snakeRenderer;consumableRenderer;powerUpRenderer;obstacleRenderer;previewObstacleRenderer;constructor(e,t){super({...e,enableDrag:!1,enablePinch:!1,enableWheel:!1},t)}setGameEngine(e){super.setGameEngine(e),e&&(this.updateRendererColors(),e.on(Le.LEVEL_CHANGE,()=>{this.obstacleRenderer?.clear()}))}async initialize(){await super.initialize()}setupRenderers(){const e=()=>{const a=this.rendering.createNode(),h=new M(a,this.rendering);return this.gameNode.addChild(h),h},t=e(),s=e(),i=e(),r=e(),o=e();this.gridRenderer=new Dt(t),this.obstacleRenderer=new Lt(s),this.previewObstacleRenderer=new Bt(s),this.consumableRenderer=new Mt(i),this.powerUpRenderer=new Gt(r),this.snakeRenderer=new Ut(o),this.registerRenderer("obstacles",this.obstacleRenderer),this.registerRenderer("previewObstacles",this.previewObstacleRenderer),this.registerRenderer("consumables",this.consumableRenderer),this.registerRenderer("powerUps",this.powerUpRenderer),this.registerRenderer("snake",this.snakeRenderer),this.gridRenderer.renderGrid()}render(e){if(!this.gameEngine||this.showSpinOverlay)return;const t=this.gameEngine,s=t.getActiveEffects();this.obstacleRenderer.setItems(t.getObstacles().getAllActive(),s),this.previewObstacleRenderer.setItems(t.getPreviewObstacles().getAllActive(),s),this.consumableRenderer.setItems(t.getConsumables().getAllActive()),this.powerUpRenderer.setItems(t.getPowerUps().getAllActive());const i=t.getSnake();i&&this.snakeRenderer.setItems([i],s)}setupEventListeners(){super.setupEventListeners(),this.input.onClick(this.handleSnakeClick)}handleSnakeClick=e=>{const t=Math.floor(e.x/d.BLOCK_SIZE),s=Math.floor(e.y/d.BLOCK_SIZE);this.events.canvasClick(new l(t,s))};updateRendererColors(){if(!this.gameEngine)return;const s=this.gameEngine.getGameConfig().gameSpecific;s&&(this.snakeRenderer.setSnakeColor(s.snakeColor),this.obstacleRenderer.setObstacleColor(s.obstacleColor))}setShowSpinOverlay(e){this.showSpinOverlay=e}onCanvasClick(e){this.events.canvasClick=e}onDirectionChange(e){this.events.directionChange=e}destroy(){super.destroy()}}const V={APPLE:"APPLE",POTION:"POTION"},Ge={APPLE:{name:"Apples",icon:"",description:n=>`Eat ${n} apple${n>1?"s":""}`},POTION:{name:"Potions",icon:"",description:n=>`Collect ${n} potion${n>1?"s":""}`}},zt="2.0.3",Vt={version:zt};function Ft(){return Vt.version}const jt={mapSelection:{type:X.STRING_LIST,label:"Map Selection",description:"Choose a specific map or let the game pick randomly",items:[...se],selectedIndex:null},snakeColor:{type:X.COLOR,label:"Snake Color",description:"Custom color for the snake's body segments",defaultValue:"#FF8000",optional:!0,format:"hex"},obstacleColor:{type:X.COLOR,label:"Obstacle Color",description:"Custom color for obstacles on the game board",defaultValue:"#00FF00",optional:!0,format:"hex"}},{GameEngine:Kt,GameCanvas:Zt,ReplayManager:Yt,GameInputType:$t,GameIntent:Xt,getVersion:qt,getGameModuleConfig:Qt}=Qe(kt,Wt,{version:Ft(),customOperators:Object.values(V),objectiveDefinitions:[],objectiveMetadata:Ge,validateCustomObjective:(n,e)=>{switch(n.operator){case V.APPLE:return(e.applesEaten||0)>=n.threshold;case V.POTION:return(e.potionsEaten||0)>=n.threshold;default:return!1}},extractGameSnapshotInfo:n=>{const e={state:n.state,score:n.score||0,level:n.level||1,levelName:n.levelName||"",applesEaten:n.applesEaten||0,potionsEaten:n.potionsEaten||0,activeEffects:(n.activeEffects||[]).map(t=>t.type)};return n.snake&&typeof n.snake.getLength=="function"&&(e.snakeLength=n.snake.getLength()),e},formatGameSnapshotInfo:n=>{const e=[];return n.state!==void 0&&e.push({label:"State",value:n.state}),typeof n.score=="number"&&e.push({label:"Score",value:n.score}),typeof n.level=="number"&&n.levelName&&e.push({label:"Level",value:`${n.level} - ${n.levelName}`}),typeof n.snakeLength=="number"&&e.push({label:"Length",value:n.snakeLength}),typeof n.applesEaten=="number"&&e.push({label:"Apples",value:n.applesEaten}),typeof n.potionsEaten=="number"&&e.push({label:"Potions",value:n.potionsEaten}),Array.isArray(n.activeEffects)&&n.activeEffects.length>0&&e.push({label:"Active Effects",value:n.activeEffects.join(", ")}),e},getProgressValue:(n,e)=>{switch(n){case V.APPLE:return e.applesEaten??null;case V.POTION:return e.potionsEaten??null;default:return null}},setupInitializationData:n=>{const e={};if(n?.mapSelection){const{items:t,selectedIndex:s}=n.mapSelection;if(s===null){const i=Math.floor(Math.random()*t.length);e.initialMapName=t[i]}else e.initialMapName=t[s]}else{const t=Math.floor(Math.random()*se.length);e.initialMapName=se[t]}return n?.snakeColor&&(e.snakeColor=n.snakeColor),n?.obstacleColor&&(e.obstacleColor=n.obstacleColor),e},getMetaConfigSchema:()=>jt,getInputMapping:()=>({[A.UP]:{keys:[{type:"single",key:"w",event:"onPressed"},{type:"single",key:"ArrowUp",event:"onPressed"}],displayText:"Move Up"},[A.DOWN]:{keys:[{type:"single",key:"s",event:"onPressed"},{type:"single",key:"ArrowDown",event:"onPressed"}],displayText:"Move Down"},[A.LEFT]:{keys:[{type:"single",key:"a",event:"onPressed"},{type:"single",key:"ArrowLeft",event:"onPressed"}],displayText:"Move Left"},[A.RIGHT]:{keys:[{type:"single",key:"d",event:"onPressed"},{type:"single",key:"ArrowRight",event:"onPressed"}],displayText:"Move Right"},[A.CLOCKWISE]:{keys:[{type:"single",key:"e",event:"onPressed"}],displayText:"Turn Right"},[A.COUNTER_CLOCKWISE]:{keys:[{type:"single",key:"q",event:"onPressed"}],displayText:"Turn Left"}})});exports.GameCanvas=Zt;exports.GameEngine=Kt;exports.GameInputType=$t;exports.GameIntent=Xt;exports.ReplayManager=Yt;exports.getGameModuleConfig=Qt;exports.getVersion=qt;exports.objectiveMetadata=Ge;
//# sourceMappingURL=game.cjs.map
